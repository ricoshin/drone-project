<html>
<head>
  <title>[ROS drone pkg] tum_ardrone/drone_autopilot</title>
  <basefont face="나눔고딕" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303244 (ko-KR, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 나눔고딕;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1549"/>
<h1>[ROS drone pkg] tum_ardrone/drone_autopilot</h1>

<div><span><div><b><br/></b></div><div><b><br/></b></div><div><b><br/></b></div><div><b>pthread_mutex_t ControlNode::logControl_CS = PTHREAD_MUTEX_INITIALIZER;</b></div><div><b><br/></b></div><div><b>// 생성자</b></div><div><b>ControlNode::ControlNode()</b></div><div><b>{</b></div><div><b>    // 메세지 발행 및 구독자 이름의 resolution 결과를 저장하기 위한 문자열 변수 선언</b></div><div><b>     <br/></b></div><div><b> </b></div><div><b>    packagePath = ros::package::getPath(&quot;tum_ardrone&quot;);</b></div><div><b><br/></b></div><div><b>    std::string val; // ~minPublishFreq 파라미터의 값을 받아오기 위한 문자열 버퍼</b></div><div><b>    float valFloat; // 받아온 문자열을 숫자로 변환하기 위한 실수형 변수</b></div><div><b><br/></b></div><div><b>    ros::param::get(&quot;~minPublishFreq&quot;, val);</b></div><div><b>    if(val.size()&gt;0)</b></div><div><b>        sscanf(val.c_str(), &quot;%f&quot;, &amp;valFloat); // 문자열에서 형식화 된 데이터를 읽어옴. 문자열로된 Freq값을 실수형으로 읽어옴</b></div><div><b>    else</b></div><div><b>        valFloat = 110; //</b></div><div><b>    minPublishFreq = valFloat;</b></div><div><b>    cout &lt;&lt; &quot;set minPublishFreq to &quot; &lt;&lt; valFloat &lt;&lt; &quot;ms&quot;&lt;&lt; endl;</b></div><div><b><br/></b></div><div><b><br/></b></div><div><b>    // other internal vars</b></div><div><b>    logfileControl = 0;</b></div><div><b>    hoverCommand.gaz = hoverCommand.pitch = hoverCommand.roll = hoverCommand.yaw = 0;</b></div><div><b>    //호버링 커맨드는 실제 모든 cmd_vel값이 0이다. (이미 0으로 초기화 되어 있지만 좀 더 확실히 하기 위한듯)</b></div><div><b>    lastControlSentMS = 0;</b></div><div><b><br/></b></div><div><b>    // channels 발행자/구독자 핸들러 객체</b></div><div><b>    dronepose_sub = nh_.subscribe(dronepose_channel, 10, &amp;ControlNode::droneposeCb, this);</b></div><div><b>    vel_pub       = nh_.advertise&lt;geometry_msgs::Twist&gt;(control_channel,1);</b></div><div><b>    tum_ardrone_pub       = nh_.advertise&lt;std_msgs::String&gt;(command_channel,50);</b></div><div><b>    tum_ardrone_sub       = nh_.subscribe(command_channel,50, &amp;ControlNode::comCb, this);</b></div><div><b>    takeoff_pub       = nh_.advertise&lt;std_msgs::Empty&gt;(takeoff_channel,1);</b></div><div><b>    land_pub       = nh_.advertise&lt;std_msgs::Empty&gt;(land_channel,1);</b></div><div><b>    toggleState_pub       = nh_.advertise&lt;std_msgs::Empty&gt;(toggleState_channel,1);</b></div><div><b><br/></b></div><div><b>    // services handler 서비스 핸들러 객체</b></div><div><b>    setReference_ = nh_.advertiseService(&quot;drone_autopilot/setReference&quot;, &amp;ControlNode::setReference, this);</b></div><div><b>    setMaxControl_ = nh_.advertiseService(&quot;drone_autopilot/setMaxControl&quot;, &amp;ControlNode::setMaxControl, this);</b></div><div><b>    setInitialReachDistance_ = nh_.advertiseService(&quot;drone_autopilot/setInitialReachDistance&quot;, &amp;ControlNode::setInitialReachDistance, this);</b></div><div><b>    setStayWithinDistance_ = nh_.advertiseService(&quot;drone_autopilot/setStayWithinDistance&quot;, &amp;ControlNode::setStayWithinDistance, this);</b></div><div><b>    setStayTime_ = nh_.advertiseService(&quot;drone_autopilot/setStayTime&quot;, &amp;ControlNode::setStayTime, this);</b></div><div><b><br/></b></div><div><b>    startControl_ = nh_.advertiseService(&quot;drone_autopilot/start&quot;, &amp;ControlNode::start, this);</b></div><div><b>    stopControl_ = nh_.advertiseService(&quot;drone_autopilot/stop&quot;, &amp;ControlNode::stop, this);</b></div><div><b>    clearCommands_ = nh_.advertiseService(&quot;drone_autopilot/clearCommands&quot;, &amp;ControlNode::clear, this);</b></div><div><b>    hover_ = nh_.advertiseService(&quot;drone_autopilot/hover&quot;, &amp;ControlNode::hover, this);</b></div><div><b>    lockScaleFP_ = nh_.advertiseService(&quot;drone_autopilot/lockScaleFP&quot;, &amp;ControlNode::lockScaleFP, this);</b></div><div><b><br/></b></div><div><b>    // internals</b></div><div><b>    parameter_referenceZero = DronePosition(TooN::makeVector(0,0,0),0);</b></div><div><b>    parameter_MaxControl = 1;</b></div><div><b>    parameter_InitialReachDist = 0.2;</b></div><div><b>    parameter_StayWithinDist = 0.5;</b></div><div><b>    parameter_StayTime = 2;</b></div><div><b>    isControlling = false;</b></div><div><b>    currentKI = NULL;</b></div><div><b>    lastSentControl = ControlCommand(0,0,0,0);</b></div><div><b><br/></b></div><div><b>    // create controller</b></div><div><b>    controller = DroneController();  // &lt;-- DroneController 생성자</b></div><div><b>    controller.node = this;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>ControlNode::~ControlNode()</b></div><div><b>{</b></div><div><b><br/></b></div><div><b>}</b></div><div><b><br/></b></div><div><b>pthread_mutex_t ControlNode::commandQueue_CS = PTHREAD_MUTEX_INITIALIZER;</b></div><div><b><br/></b></div><div><b>// 토픽 /ardrone/predictedPose로 발행되는 메시지를 받는 콜백 (filter_state타입으로 받음)</b></div><div><b>void ControlNode::droneposeCb(const tum_ardrone::filter_stateConstPtr statePtr)</b></div><div><b>{</b></div><div><b>    // 커맨드 큐 사용하는 부분 Lock</b></div><div><b>    pthread_mutex_lock(&amp;commandQueue_CS);</b></div><div><b><br/></b></div><div><b>    // 현재 존재하는 KI가 없는 상황에서 다음 KI가 존재하면 계속해서 popNextCommand().</b></div><div><b>    while(currentKI == NULL &amp;&amp; commandQueue.size() &gt; 0)</b></div><div><b>        popNextCommand(statePtr);</b></div><div><b><br/></b></div><div><b>    // 현재 KI가 있으면, 컨트롤 업데이트!</b></div><div><b>    if(currentKI != NULL)</b></div><div><b>    {</b></div><div><b>        // let current KI control.</b></div><div><b>        this-&gt;updateControl(statePtr);</b></div><div><b>    }</b></div><div><b>    // autopilot이 컨트롤 중이지만 KI가 없으면 호버링!</b></div><div><b>    else if(isControlling)</b></div><div><b>    {</b></div><div><b>        sendControlToDrone(hoverCommand); // 호버링 명령 전송.</b></div><div><b>        ROS_DEBUG(&quot;Autopilot is Controlling, but there is no KI -&gt; sending HOVER&quot;);</b></div><div><b>    }</b></div><div><b><br/></b></div><div><b>    pthread_mutex_unlock(&amp;commandQueue_CS);</b></div><div><b>}</b></div><div><b><br/></b></div><div><b><br/></b></div><div><b>// 커맨드 큐에서 다음 커맨드를 꺼냄(pop). 전부 다 꺼냈음이 확인될 때 까지.</b></div><div><b>// 커맨트 큐 '락' 특성이 존재하는 듯!</b></div><div><b>void ControlNode::popNextCommand(const tum_ardrone::filter_stateConstPtr statePtr)</b></div><div><b>{</b></div><div><b>    // 만약을 위해 현존하는 KI를 삭제해줌.</b></div><div><b>    if(currentKI != NULL)</b></div><div><b>    {</b></div><div><b>        delete currentKI;</b></div><div><b>        currentKI = NULL;</b></div><div><b>    }</b></div><div><b><br/></b></div><div><b>    // 다음 명령어를 읽음.</b></div><div><b>    while(currentKI == NULL &amp;&amp; commandQueue.size() &gt; 0)</b></div><div><b>    {    // 현재 KI가 없고, 커맨드 큐에 다음 KI가 있을 때.</b></div><div><b>        std::string command = commandQueue.front(); // 가장 첫번째 큐를 command 변수에 복사</b></div><div><b>        commandQueue.pop_front(); // 큐에 남아있는 첫번째 큐는 날려버림.</b></div><div><b>        bool commandUnderstood = false; // 커맨드 인식 성공 확인용 플래그. false 초기화. 루프 마지막에 true인지 체크.</b></div><div><b><br/></b></div><div><b>        // print me</b></div><div><b>        ROS_INFO(&quot;executing command: %s&quot;,command.c_str()); // 실행될 커맨드 프린트</b></div><div><b><br/></b></div><div><b>        int p;</b></div><div><b>        char buf[100];</b></div><div><b>        float parameters[10];</b></div><div><b><br/></b></div><div><b>        // 매크로 문자열 교체 (x,y,z,yaw)</b></div><div><b>        if((p = command.find(&quot;$POSE$&quot;)) != std::string::npos)</b></div><div><b>        {</b></div><div><b>            snprintf(buf,100, &quot;%.3f %.3f %.3f %.3f&quot;,statePtr-&gt;x,statePtr-&gt;y,statePtr-&gt;z,statePtr-&gt;yaw);</b></div><div><b>            command.replace(p,6,buf);</b></div><div><b>        }</b></div><div><b>        if((p = command.find(&quot;$REFERENCE$&quot;)) != std::string::npos)</b></div><div><b>        {</b></div><div><b>            snprintf(buf,100, &quot;%.3f %.3f %.3f %.3f&quot;,parameter_referenceZero.pos[0],parameter_referenceZero.pos[1],parameter_referenceZero.pos[2],parameter_referenceZero.yaw);</b></div><div><b>            command.replace(p,11,buf);</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        //========================================================</b></div><div><b><br/></b></div><div><b>        // 명령어 처리</b></div><div><b>        // autoInit</b></div><div><b>        if(sscanf(command.c_str(),&quot;autoInit %f %f %f %f&quot;,&amp;parameters[0], &amp;parameters[1], &amp;parameters[2], &amp;parameters[3]) == 4)</b></div><div><b>        {</b></div><div><b>            currentKI = new KIAutoInit(true,parameters[0],parameters[1],parameters[2],parameters[3],true);</b></div><div><b>            currentKI-&gt;setPointers(this,&amp;controller); // 첫 번째 인수 : ControlNode 객체의 주소 / 두 번째 인수 :  ControlNode에서 선언한 DroneController 객체의 주소.</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        else if(sscanf(command.c_str(),&quot;autoTakeover %f %f %f %f&quot;,&amp;parameters[0], &amp;parameters[1], &amp;parameters[2], &amp;parameters[3]) == 4)</b></div><div><b>        {</b></div><div><b>            currentKI = new KIAutoInit(true,parameters[0],parameters[1],parameters[2],parameters[3],false);</b></div><div><b>            currentKI-&gt;setPointers(this,&amp;controller);</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // takeoff</b></div><div><b>        else if(command == &quot;takeoff&quot;)</b></div><div><b>        {</b></div><div><b>            currentKI = new KIAutoInit(false);</b></div><div><b>            currentKI-&gt;setPointers(this,&amp;controller);</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // setOffset</b></div><div><b>        else if(sscanf(command.c_str(),&quot;setReference %f %f %f %f&quot;,&amp;parameters[0], &amp;parameters[1], &amp;parameters[2], &amp;parameters[3]) == 4)</b></div><div><b>        {</b></div><div><b>            parameter_referenceZero = DronePosition(TooN::makeVector(parameters[0],parameters[1],parameters[2]),parameters[3]);</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // setMaxControl</b></div><div><b>        else if(sscanf(command.c_str(),&quot;setMaxControl %f&quot;,&amp;parameters[0]) == 1)</b></div><div><b>        {</b></div><div><b>            parameter_MaxControl = parameters[0];</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // setInitialReachDist</b></div><div><b>        else if(sscanf(command.c_str(),&quot;setInitialReachDist %f&quot;,&amp;parameters[0]) == 1)</b></div><div><b>        {</b></div><div><b>            parameter_InitialReachDist = parameters[0];</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // setStayWithinDist</b></div><div><b>        else if(sscanf(command.c_str(),&quot;setStayWithinDist %f&quot;,&amp;parameters[0]) == 1)</b></div><div><b>        {</b></div><div><b>            parameter_StayWithinDist = parameters[0];</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // setStayTime</b></div><div><b>        else if(sscanf(command.c_str(),&quot;setStayTime %f&quot;,&amp;parameters[0]) == 1)</b></div><div><b>        {</b></div><div><b>            parameter_StayTime = parameters[0];</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // goto</b></div><div><b>        else if(sscanf(command.c_str(),&quot;goto %f %f %f %f&quot;,&amp;parameters[0], &amp;parameters[1], &amp;parameters[2], &amp;parameters[3]) == 4)</b></div><div><b>        {</b></div><div><b>            currentKI = new KIFlyTo(</b></div><div><b>                DronePosition(</b></div><div><b>                TooN::makeVector(parameters[0],parameters[1],parameters[2]) + parameter_referenceZero.pos,</b></div><div><b>                    parameters[3] + parameter_referenceZero.yaw),</b></div><div><b>                parameter_StayTime,</b></div><div><b>                parameter_MaxControl,</b></div><div><b>                parameter_InitialReachDist,</b></div><div><b>                parameter_StayWithinDist</b></div><div><b>                );</b></div><div><b>            currentKI-&gt;setPointers(this,&amp;controller);</b></div><div><b>            commandUnderstood = true;</b></div><div><b><br/></b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // moveBy</b></div><div><b>        else if(sscanf(command.c_str(),&quot;moveBy %f %f %f %f&quot;,&amp;parameters[0], &amp;parameters[1], &amp;parameters[2], &amp;parameters[3]) == 4)</b></div><div><b>        {</b></div><div><b>            currentKI = new KIFlyTo(</b></div><div><b>                DronePosition(</b></div><div><b>                TooN::makeVector(parameters[0],parameters[1],parameters[2]) + controller.getCurrentTarget().pos,</b></div><div><b>                    parameters[3] + controller.getCurrentTarget().yaw),</b></div><div><b>                parameter_StayTime,</b></div><div><b>                parameter_MaxControl,</b></div><div><b>                parameter_InitialReachDist,</b></div><div><b>                parameter_StayWithinDist</b></div><div><b>                );</b></div><div><b>            currentKI-&gt;setPointers(this,&amp;controller);</b></div><div><b>            commandUnderstood = true;</b></div><div><b><br/></b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // moveByRel</b></div><div><b>        else if(sscanf(command.c_str(),&quot;moveByRel %f %f %f %f&quot;,&amp;parameters[0], &amp;parameters[1], &amp;parameters[2], &amp;parameters[3]) == 4)</b></div><div><b>        {</b></div><div><b>            currentKI = new KIFlyTo(</b></div><div><b>                DronePosition(</b></div><div><b>                TooN::makeVector(parameters[0]+statePtr-&gt;x,parameters[1]+statePtr-&gt;y,parameters[2]+statePtr-&gt;z),</b></div><div><b>                    parameters[3] + statePtr-&gt;yaw),</b></div><div><b>                parameter_StayTime,</b></div><div><b>                parameter_MaxControl,</b></div><div><b>                parameter_InitialReachDist,</b></div><div><b>                parameter_StayWithinDist</b></div><div><b>                );</b></div><div><b>            currentKI-&gt;setPointers(this,&amp;controller);</b></div><div><b>            commandUnderstood = true;</b></div><div><b><br/></b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // land</b></div><div><b>        else if(command == &quot;land&quot;)</b></div><div><b>        {</b></div><div><b>            currentKI = new KILand();</b></div><div><b>            currentKI-&gt;setPointers(this,&amp;controller);</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // setScaleFP</b></div><div><b>        else if(command == &quot;lockScaleFP&quot;)</b></div><div><b>        {</b></div><div><b>            publishCommand(&quot;p lockScaleFP&quot;);</b></div><div><b>            commandUnderstood = true;</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        if(!commandUnderstood) // 명령어 인식 성공 확인.</b></div><div><b>            ROS_INFO(&quot;unknown command, skipping!&quot;);</b></div><div><b>    }</b></div><div><b><br/></b></div><div><b>}</b></div><div><b><br/></b></div><div><b><br/></b></div><div><b>// 토픽 /tum_ardrone/com으로 발행되는 메시지를 받는 콜백 (문자열 받음)</b></div><div><b>void ControlNode::comCb(const std_msgs::StringConstPtr str)</b></div><div><b>{</b></div><div><b>    // 접두어 'c'로 시작하는 커맨드만 처리</b></div><div><b>    if(str-&gt;data.length() &gt; 2 &amp;&amp; str-&gt;data.substr(0,2) == &quot;c &quot;)</b></div><div><b>    {    // 문자열 길이가 2개 이상이고 처음 두 글자가 &quot;c &quot;로 시작하면.</b></div><div><b>        std::string cmd =str-&gt;data.substr(2,str-&gt;data.length()-2);</b></div><div><b>        // 세번째 글자부터 마지막까지 cmd 변수에 저장.</b></div><div><b><br/></b></div><div><b>        if(cmd.length() == 4 &amp;&amp; cmd.substr(0,4) == &quot;stop&quot;)</b></div><div><b>        {</b></div><div><b>            stopControl();</b></div><div><b>        }</b></div><div><b>        else if(cmd.length() == 5 &amp;&amp; cmd.substr(0,5) == &quot;start&quot;)</b></div><div><b>        {</b></div><div><b>            startControl();</b></div><div><b>        }</b></div><div><b>        else if(cmd.length() == 13 &amp;&amp; cmd.substr(0,13) == &quot;clearCommands&quot;)</b></div><div><b>        {</b></div><div><b>            clearCommands();</b></div><div><b>        }</b></div><div><b>        else // stop / start / clearCommands가 아닐 경우에는 커맨드 큐에 집어 넣음.</b></div><div><b>        {</b></div><div><b>            // 커맨드 큐 사용하는 부분 Lock</b></div><div><b>            pthread_mutex_lock(&amp;commandQueue_CS);</b></div><div><b>            commandQueue.push_back(cmd); // 커맨트 큐에 커맨드 밀어넣음 (push)</b></div><div><b>            pthread_mutex_unlock(&amp;commandQueue_CS);</b></div><div><b>        }</b></div><div><b>    }</b></div><div><b><br/></b></div><div><b>    // 특수케이스</b></div><div><b>    // global command: toggle log</b></div><div><b>    if(str-&gt;data.length() == 9 &amp;&amp; str-&gt;data.substr(0,9) == &quot;toggleLog&quot;)</b></div><div><b>    {</b></div><div><b>        // toggleLog로 시작하는 명령어일 경우.</b></div><div><b>        this-&gt;toogleLogging();</b></div><div><b>    }</b></div><div><b>}</b></div><div><b><br/></b></div><div><b><br/></b></div><div><b>// 실제 메인 루프</b></div><div><b>void ControlNode::Loop()</b></div><div><b>{</b></div><div><b>    // 초시계 스타트!</b></div><div><b>    ros::Time last = ros::Time::now(); // 현재 시간 저장  : 초시계1 스타트!</b></div><div><b>    ros::Time lastStateUpdate = ros::Time::now(); // 현재 시간 저장 : 초시계2 스타트!</b></div><div><b><br/></b></div><div><b>    while (nh_.ok())</b></div><div><b>    {</b></div><div><b><br/></b></div><div><b>        // -------------- 1. spin for 50ms, do main controlling part here. ---------------</b></div><div><b>        while((ros::Time::now() - last) &lt; ros::Duration(minPublishFreq / 1000.0))</b></div><div><b>            ros::getGlobalCallbackQueue()-&gt;callAvailable(ros::WallDuration(minPublishFreq / 1000.0 - (ros::Time::now() - last).toSec()));</b></div><div><b>        // minPublishFreq : 해당 밀리초(초기값 110밀리초))동안 계속 루프수행.</b></div><div><b>        // minPublishFreq / 1000.0 : 밀리초 -&gt; 초 변환. (ros::Duration의 생성자는 하나의 인수를 받을때는 초의 실수형을 받음)</b></div><div><b>        // 소요시간이 파라미터(minPublishFreq)가 정한 시간이 될 때까지 계속해서 수행.</b></div><div><b>        // (루프수행시간 - 소요시간) = (남은 시간)</b></div><div><b>        // 루프를 돌 때마다 한 번씩만 호출</b></div><div><b><br/></b></div><div><b>        last = ros::Time::now(); // 초시계1 리셋!</b></div><div><b><br/></b></div><div><b><br/></b></div><div><b>        // -------------- 2. send hover (maybe). ---------------</b></div><div><b>        if(isControlling &amp;&amp; getMS(ros::Time::now()) - lastControlSentMS &gt; minPublishFreq)</b></div><div><b>        {    // isControlling : startControl호출시 True / stopControl 호출시 False</b></div><div><b>            // 컨트롤 시작 상태에서 최소 퍼블리쉬 시간을 초과하였을 때,</b></div><div><b>            sendControlToDrone(hoverCommand);</b></div><div><b>            ROS_WARN(&quot;Autopilot enabled, but no estimated pose received - sending HOVER.&quot;);</b></div><div><b>        }</b></div><div><b><br/></b></div><div><b>        // -------------- 2. update info. ---------------</b></div><div><b>        if((ros::Time::now() - lastStateUpdate) &gt; ros::Duration(0.4))</b></div><div><b>        {</b></div><div><b>            reSendInfo();</b></div><div><b>            lastStateUpdate = ros::Time::now();</b></div><div><b>        }</b></div><div><b>    }</b></div><div><b>}</b></div><div><b>void ControlNode::dynConfCb(tum_ardrone::AutopilotParamsConfig &amp;config, uint32_t level)</b></div><div><b>{</b></div><div><b>    controller.Ki_gaz = config.Ki_gaz;</b></div><div><b>    controller.Kd_gaz = config.Kd_gaz;</b></div><div><b>    controller.Kp_gaz = config.Kp_gaz;</b></div><div><b><br/></b></div><div><b>    controller.Ki_rp = config.Ki_rp;</b></div><div><b>    controller.Kd_rp = config.Kd_rp;</b></div><div><b>    controller.Kp_rp = config.Kp_rp;</b></div><div><b><br/></b></div><div><b>    controller.Ki_yaw = config.Ki_yaw;</b></div><div><b>    controller.Kd_yaw = config.Kd_yaw;</b></div><div><b>    controller.Kp_yaw = config.Kp_yaw;</b></div><div><b><br/></b></div><div><b>    controller.max_gaz_drop = config.max_gaz_drop;</b></div><div><b>    controller.max_gaz_rise = config.max_gaz_rise;</b></div><div><b>    controller.max_rp = config.max_rp;</b></div><div><b>    controller.max_yaw = config.max_yaw;</b></div><div><b>    controller.agressiveness = config.agressiveness;</b></div><div><b>    controller.rise_fac = config.rise_fac;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>pthread_mutex_t ControlNode::tum_ardrone_CS = PTHREAD_MUTEX_INITIALIZER;</b></div><div><b>void ControlNode::publishCommand(std::string c)</b></div><div><b>{</b></div><div><b>    std_msgs::String s;</b></div><div><b>    s.data = c.c_str();</b></div><div><b>    pthread_mutex_lock(&amp;tum_ardrone_CS);</b></div><div><b>    tum_ardrone_pub.publish(s);</b></div><div><b>    pthread_mutex_unlock(&amp;tum_ardrone_CS);</b></div><div><b>}</b></div><div><b><br/></b></div><div><b><br/></b></div><div><b>void ControlNode::toogleLogging()</b></div><div><b>{</b></div><div><b>    // logging has yet to be integrated.</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>void ControlNode::sendControlToDrone(ControlCommand cmd)</b></div><div><b>{</b></div><div><b>    geometry_msgs::Twist cmdT;</b></div><div><b>    cmdT.angular.z = -cmd.yaw;</b></div><div><b>    cmdT.linear.z = cmd.gaz;</b></div><div><b>    cmdT.linear.x = -cmd.pitch;</b></div><div><b>    cmdT.linear.y = -cmd.roll;</b></div><div><b><br/></b></div><div><b>    // assume that while actively controlling, the above for will never be equal to zero, so i will never hover.</b></div><div><b>    cmdT.angular.x = cmdT.angular.y = 0;</b></div><div><b><br/></b></div><div><b>    if(isControlling)</b></div><div><b>    {</b></div><div><b>        vel_pub.publish(cmdT);</b></div><div><b>        lastSentControl = cmd;</b></div><div><b>    }</b></div><div><b><br/></b></div><div><b>    lastControlSentMS = getMS(ros::Time::now());</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>void ControlNode::sendLand()</b></div><div><b>{</b></div><div><b>    if(isControlling)</b></div><div><b>        land_pub.publish(std_msgs::Empty());</b></div><div><b>}</b></div><div><b>void ControlNode::sendTakeoff()</b></div><div><b>{</b></div><div><b>    if(isControlling)</b></div><div><b>        takeoff_pub.publish(std_msgs::Empty());</b></div><div><b>}</b></div><div><b>void ControlNode::sendToggleState()</b></div><div><b>{</b></div><div><b>    if(isControlling)</b></div><div><b>        toggleState_pub.publish(std_msgs::Empty());</b></div><div><b>}</b></div><div><b>void ControlNode::reSendInfo()</b></div><div><b>{</b></div><div><b>    /*</b></div><div><b>    Idle / Controlling (Queue: X)</b></div><div><b>    Current:</b></div><div><b>    Next:</b></div><div><b>    Target: X,X,X,X</b></div><div><b>    Error: X,X,X,X</b></div><div><b>    */</b></div><div><b><br/></b></div><div><b>    DronePosition p = controller.getCurrentTarget();</b></div><div><b>    TooN::Vector&lt;4&gt; e = controller.getLastErr();</b></div><div><b>    double ea = sqrt(e[0]*e[0] + e[1]*e[1] + e[2]*e[2]);</b></div><div><b>    snprintf(buf,500,&quot;u c %s (Queue: %d)\nCurrent: %s\nNext: %s\nTarget: (%.2f,  %.2f,  %.2f), %.1f\nError: (%.2f,  %.2f,  %.2f), %.1f (|.| %.2f)\nCont.: r %.2f, p %.2f, g %.2f, y %.2f&quot;,</b></div><div><b>            isControlling ? &quot;Controlling&quot; : &quot;Idle&quot;,</b></div><div><b>            (int)commandQueue.size(),</b></div><div><b>            currentKI == NULL ? &quot;NULL&quot; : currentKI-&gt;command.c_str(),</b></div><div><b>            commandQueue.size() &gt; 0 ? commandQueue.front().c_str() : &quot;NULL&quot;,</b></div><div><b>            p.pos[0],p.pos[1],p.pos[2],p.yaw,</b></div><div><b>            e[0],e[1],e[2],e[3], ea,</b></div><div><b>            lastSentControl.roll, lastSentControl.pitch, lastSentControl.gaz, lastSentControl.yaw);</b></div><div><b><br/></b></div><div><b>    publishCommand(buf);</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>void ControlNode::startControl() {</b></div><div><b>    isControlling = true;</b></div><div><b>    publishCommand(&quot;u l Autopilot: Start Controlling&quot;);</b></div><div><b>    ROS_INFO(&quot;START CONTROLLING!&quot;);</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>void ControlNode::stopControl() {</b></div><div><b>    isControlling = false;</b></div><div><b>    publishCommand(&quot;u l Autopilot: Stop Controlling&quot;);</b></div><div><b>    ROS_INFO(&quot;STOP CONTROLLING!&quot;);</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>void ControlNode::updateControl(const tum_ardrone::filter_stateConstPtr statePtr) {</b></div><div><b>    if (currentKI-&gt;update(statePtr) &amp;&amp; commandQueue.size() &gt; 0) {</b></div><div><b>        delete currentKI;</b></div><div><b>        currentKI = NULL;</b></div><div><b>    }</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>void ControlNode::clearCommands() {</b></div><div><b>    pthread_mutex_lock(&amp;commandQueue_CS);</b></div><div><b>    commandQueue.clear();                        // clear command queue.</b></div><div><b>    controller.clearTarget();                    // clear current controller target</b></div><div><b>    if(currentKI != NULL) delete currentKI;    // destroy &amp; delete KI.</b></div><div><b>    currentKI = NULL;</b></div><div><b>    pthread_mutex_unlock(&amp;commandQueue_CS);</b></div><div><b>    publishCommand(&quot;u l Autopilot: Cleared Command Queue&quot;);</b></div><div><b>    ROS_INFO(&quot;Cleared Command Queue!&quot;);</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::setReference(SetReference::Request&amp; req, SetReference::Response&amp; res)</b></div><div><b>{</b></div><div><b>    ROS_INFO(&quot;calling service setReference&quot;);</b></div><div><b>    parameter_referenceZero = DronePosition(TooN::makeVector(req.x, req.y, req.z), req.heading);   </b></div><div><b>    res.status = true;</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::setMaxControl(SetMaxControl::Request&amp; req, SetMaxControl::Response&amp; res)</b></div><div><b>{</b></div><div><b>    ROS_INFO(&quot;calling service setMaxControl&quot;);</b></div><div><b>    parameter_MaxControl = req.speed;</b></div><div><b>    res.status = true;</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::setInitialReachDistance(SetInitialReachDistance::Request&amp; req, SetInitialReachDistance::Response&amp; res)</b></div><div><b>{</b></div><div><b>    ROS_INFO(&quot;calling service setInitialReachDistance&quot;);</b></div><div><b>    parameter_InitialReachDist = req.distance;</b></div><div><b>    res.status = true;</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::setStayWithinDistance(SetStayWithinDistance::Request&amp; req, SetStayWithinDistance::Response&amp; res) {</b></div><div><b>    ROS_INFO(&quot;calling service setStayWithinDistance&quot;);</b></div><div><b>    parameter_StayWithinDist = req.distance;</b></div><div><b>    res.status = true;</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::setStayTime(SetStayTime::Request&amp; req, SetStayTime::Response&amp; res) {</b></div><div><b>    ROS_INFO(&quot;calling service setStayTime&quot;);</b></div><div><b>    parameter_StayTime = req.duration;</b></div><div><b>    res.status = true;</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::start(std_srvs::Empty::Request&amp; req, std_srvs::Empty::Response&amp; res) {</b></div><div><b>    ROS_INFO(&quot;calling service start&quot;);</b></div><div><b>    this-&gt;startControl();</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::stop(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;) {</b></div><div><b>    ROS_INFO(&quot;calling service stop&quot;);</b></div><div><b>    this-&gt;stopControl();</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::clear(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;) {</b></div><div><b>    ROS_INFO(&quot;calling service clearCommands&quot;);</b></div><div><b>    this-&gt;clearCommands();</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::hover(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;) {</b></div><div><b>    ROS_INFO(&quot;calling service hover&quot;);</b></div><div><b>    this-&gt;sendControlToDrone(hoverCommand);</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b>bool ControlNode::lockScaleFP(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;) {</b></div><div><b>    ROS_INFO(&quot;calling service lockScaleFP&quot;);</b></div><div><b>    this-&gt;publishCommand(&quot;p lockScaleFP&quot;);</b></div><div><b>    return true;</b></div><div><b>}</b></div><div><b><br/></b></div><div><b><br/></b></div><div><b><br/></b></div><div><span style="font-size: 32px;"><b>Message</b></span></div><div style="font-size: 16px;"><b><br/></b></div><div style="font-size: 16px;"><b>발행하는 메세지</b></div><div style="font-size: 16px;"><b><br/></b></div><table style="border-collapse: collapse; margin-left: 0px;table-layout:fixed;width:60.91142490372272%;"><tbody><tr><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:19.28345626975764%;"><div style="text-align: center"><b>Graphic resource</b></div><div style="text-align: center"><b>name</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:14.64699683877766%;"><div style="text-align: center">tum_ardrone/com</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:18.545837723919917%;"><div style="text-align: center">cmd_vel</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:15.806111696522656%;"><div style="text-align: center">ardrone/takeoff</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:16.12223393045311%;"><div style="text-align: center">ardrone/land</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:15.489989462592202%;"><div style="text-align: center">ardrone/reset</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center"><b>Header</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">&quot;std_msgs/String.h&quot;</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">&quot;geometry_msgs/Twist.h&quot;</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">&quot;std_msgs/Empty.h&quot;</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">&quot;std_msgs/Empty.h&quot;</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">&quot;std_msgs/Empty.h&quot;</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center"><b>Type</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">std_msgs::String</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">geometry_msgs::Twist</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">std_msgs::Empty</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">std_msgs::Empty</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">std_msgs::Empty</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center"><b>Variable name</b></div><div style="text-align: center"><b>(ros::Publisher)</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">tum_ardrone_pub</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">vel_pub</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">takeoff_pub</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">land_pub</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">toggleState_pub</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center"><b>Callback</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">-</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">-</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">-</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">-</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">-</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center"><b>Resolved name</b></div><div style="text-align: center"><b>문자열 변수 </b><b>(std::string)</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">command_channel</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">control_channel</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:20%;"><div style="text-align: center">takeoff_channel</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">land_channel</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:10%;"><div style="text-align: center">toggleState_channel</div></td></tr></tbody></table><div style="font-size: 16px;"><b><br/></b></div><div style="font-size: 16px;"><b>구독하는 메세지</b></div><div style="font-size: 16px;"><b><br/></b></div><table style="border-collapse: collapse; margin-left: 0px;table-layout:fixed;width:36.13607188703466%;"><tbody><tr><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:36.41207815275311%;"><div style="text-align: center"><b>Graphic resource</b></div><div style="text-align: center"><b>name</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:29.129662522202487%;"><div style="text-align: center">tum_ardrone/com</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:34.280639431616336%;"><div style="text-align: center">ardrone/predictedPose</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center"><b>Header</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">&quot;std_msgs/String.h&quot;</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">&quot;tum_ardrone/<span style="color: rgb(222, 87, 0);">filter_state.h</span>&quot;</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center"><b>Type</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">std_msgs::String</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">tum_ardrone::filter_state</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center"><b>Variable name</b></div><div style="text-align: center"><b>(ros::Subscriber)</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">tum_ardrone_sub</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">dronepose_sub</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center"><b>Callback</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">comCb()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">droneposeCb()</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center"><b>Resolved name 문자열 변수</b></div><div style="text-align: center"><b>(std::string)</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">command_channel</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:33.33%;"><div style="text-align: center">dronepose_channel</div></td></tr></tbody></table><div style="font-size: 16px;"><b><br/></b></div><div><span style="font-size: 19px;"><b>&lt;geometry_msgs/Twist.h&gt;</b></span></div><div style="font-size: 16px;"><b><br/></b></div><div style="font-size: 16px;"><b>Twist.msg 내용</b></div><div>Vector3  linear</div><div>Vector3  angular</div><div style="font-size: 16px;"><b><br/></b></div><div><span style="font-size: 18px;"><b>&lt;tum_ardrone/<span style="color: rgb(255, 102, 0);">filter_state.h</span>&gt;</b></span></div><div><br/></div><div><span style="font-size: 16px;"><b>fliter_state.msg 내용</b></span></div><div><b><span style="font-size: 16px;"><br/></span></b></div><div><span style="color: rgb(51, 153, 102);"># 상수 (PTAM 현재 상태 마크용)</span></div><div>uint32 <b>PTAM_IDLE</b> = 0 <span style="color: rgb(51, 153, 102);"># 동작하지 않음.</span></div><div>uint32 <b>PTAM_INITIALIZING</b> = 1 <span style="color: rgb(51, 153, 102);"># 초기화 (trails)</span></div><div>uint32 <b>PTAM_LOST</b> = 2 <span style="color: rgb(51, 153, 102);"># 실행중이나 트랙킹 로스트.</span></div><div>uint32 <b>PTAM_GOOD</b> = 3 <span style="color: rgb(51, 153, 102);"># 트랙킹 좋음</span></div><div>uint32 <b>PTAM_BEST</b> = 4 <span style="color: rgb(51, 153, 102);"># 트랙킹 매우 좋음</span></div><div>uint32 <b>PTAM_TOOKKF</b> = 5 <span style="color: rgb(51, 153, 102);"># 새로운 키프레임 획득 (PTAM_BEST와 동일)</span></div><div>uint32 <b>PTAM_FALSEPOSITIVE</b> = 6 <span style="color: rgb(51, 153, 102);"># PTAM은 잘된다고 나오지만 예측은 잘 되지 않음.</span></div><div><br/></div><div><span style="color: rgb(51, 153, 102);"># 헤더</span></div><div>Header <b>header</b></div><div><br/></div><div><span style="color: rgb(51, 153, 102);"># ----------------- raw 10d filter state ----------------------------</span></div><div>float32 <b>x</b>, <b>y</b>, <b>z</b></div><div>float32 <b>dx</b>, <b>dy</b>, <b>dz</b></div><div>float32 <b>roll</b>, <b>pitch</b>, <b>yaw</b></div><div>float32 <b>dyaw</b></div><div><br/></div><div><span style="color: rgb(51, 153, 102);"># --------------------- other values ---------------------------</span></div><div>float32 <b>scale</b> <span style="color: rgb(51, 153, 102);"># ptam scale factor (PTAMpos * scale = WORLDpos).</span></div><div>uint32 <b>ptamState</b></div><div>float32 <b>scaleAccuracy</b> <span style="color: rgb(51, 153, 102);"># 0.5 : 매우 부정확 / 1(최대) : 매우 정확</span></div><div><br/></div><div><span style="color: rgb(51, 153, 102);"># ----------------- propagated from drone messages: -----------------</span></div><div><span style="color: rgb(51, 153, 102);"># 0: Unknown, 1: Init, 2: Landed, 3: Flying, 4: Hovering, 5: Test</span></div><div><span style="color: rgb(51, 153, 102);"># 6: Taking off, 7: Goto Fix Point, 8: Landing, 9: Looping</span></div><div><span style="color: rgb(51, 153, 102);"># Note: 3,7 seems to discriminate type of flying (isFly = 3 | 7)</span></div><div>uint32 <b>droneState</b></div><div>float32 <b>batteryPercent</b> <span style="color: rgb(51, 153, 102);"># 0 ~ 100</span></div><div><b><br/></b></div><div><b><br/></b></div><div><hr/></div><div><b><br/></b></div><div><span style="font-size: 32px;"><b>Service</b></span></div><div><br/></div><div><span style="font-size: 19px;"><b>패키지 자체 생성 서비스타입</b></span></div><div><br/></div><table style="border-collapse: collapse; margin-left: 0px;table-layout:fixed;width:58.15147625160462%;"><tbody><tr><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:18.653421633554085%;"><div style="text-align: center"><b>Graphic resource</b></div><div style="text-align: center"><b>name</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:14.348785871964681%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>setReference</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:14.56953642384106%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>setMaxControl</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:19.867549668874172%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>setInitialReachDistance</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:19.094922737306845%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>setStayWithinDistance</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:13.35540838852097%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>setStayTime</b></div></td></tr><tr><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:12.182410423452769%;"><div style="text-align: center"><b>Header</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:16.612377850162865%;"><div style="text-align: center">&quot;tum_ardrone/</div><div style="text-align: center"><span style="color: rgb(255, 102, 0);">SetReference.h&quot;</span></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:15.374592833876221%;"><div style="text-align: center">&quot;tum_ardrone/</div><div style="text-align: center"><span style="color: rgb(255, 102, 0);">SetMaxControl.h&quot;</span></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:19.348534201954397%;"><div style="text-align: center">&quot;tum_ardrone/</div><div style="text-align: center"><span style="color: rgb(255, 102, 0);">SetInitialReachDistance.h&quot;</span></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:21.758957654723126%;"><div style="text-align: center">&quot;tum_ardrone/</div><div style="text-align: center"><span style="color: rgb(255, 102, 0);">SetStayWithinDistance.h&quot;</span></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:14.65798045602606%;"><div style="text-align: center">&quot;tum_ardrone/</div><div style="text-align: center"><span style="color: rgb(255, 102, 0);">SetStayTime.h&quot;</span></div></td></tr><tr><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:12.182410423452769%;"><div style="text-align: center"><b>Type</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:16.612377850162865%;"><div style="text-align: center">tum_ardrone::</div><div style="text-align: center">SetReference</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:15.374592833876221%;"><div style="text-align: center">tum_ardrone::</div><div style="text-align: center">SetMaxControl</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:19.348534201954397%;"><div style="text-align: center">tum_ardrone::</div><div style="text-align: center">SetInitialReachDistance</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:21.758957654723126%;"><div style="text-align: center">tum_ardrone::</div><div style="text-align: center">SetStayWithinDistance</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:14.65798045602606%;"><div style="text-align: center">tum_ardrone::</div><div style="text-align: center">SetStayTime</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Request</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">float32 <b>x</b></div><div style="text-align: center">float32 <b>y</b></div><div style="text-align: center">float32 <b>z</b></div><div style="text-align: center">float32 <b>heading</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">float32 <b>speed</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">float32 <b>speed</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">float32 <b>distance</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">float32 <b>duration</b></div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Response</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">bool <b>status</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">bool <b>status</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">bool <b>status</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">bool <b>status</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">bool <b>status</b></div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Description</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">레퍼런스(기준)</div><div style="text-align: center">포즈 설정</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">최대 컨트롤</div><div style="text-align: center">스피드 설정</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">최초 도달 인정</div><div style="text-align: center">거리 설정</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">도달 인정을 위해</div><div style="text-align: center">머물러야 하는</div><div style="text-align: center">거리 범위 설정</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">도달 인정을 위해</div><div style="text-align: center">머물러야하는</div><div style="text-align: center">시간 설정</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Variable name</b></div><div style="text-align: center"><b>(ros::ServiceServer)</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setReference_</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setMaxControl_</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setInitialReachDistance_</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setStayWithinDistance_</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setStayTime_</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Callback</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setReference()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setMaxControl()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setInitialReachDistance()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setStayWithinDistance()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setStayTime()</div></td></tr></tbody></table><div><br/></div><div><br/></div><div><b><span style="font-size: 19px;">ROS 표준 서비스 타입</span></b></div><div><br/></div><table style="border-collapse: collapse; margin-left: 0px;table-layout:fixed;width:56.93196405648266%;"><tbody><tr><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:14.317925591882751%;"><div style="text-align: center"><b>Graphic</b></div><div style="text-align: center"><b>resource name</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:15.44532130777903%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>start</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:16.798196166854567%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>stop</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:18.714768883878243%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>clearCommands</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:19.39120631341601%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>hover</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:15.219842164599775%;"><div style="text-align: center">drone_autopilot/</div><div style="text-align: center"><b>lockScaleFP</b></div></td></tr><tr><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:12.182410423452769%;"><div style="text-align: center"><b>Header</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:16.612377850162865%;"><div style="text-align: center">&quot;std_srvs/Empty.h&quot;</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:15.439739413680782%;"><div style="text-align: center">&quot;std_srvs/Empty.h&quot;</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:19.348534201954397%;"><div style="text-align: center">&quot;std_srvs/Empty.h&quot;</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:21.693811074918568%;"><div style="text-align: center">&quot;std_srvs/Empty.h&quot;</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:14.65798045602606%;"><div style="text-align: center">&quot;std_srvs/Empty.h&quot;</div></td></tr><tr><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:12.182410423452769%;"><div style="text-align: center"><b>Type</b></div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:16.612377850162865%;"><div style="text-align: center">std_srvs::Empty</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:15.439739413680782%;"><div style="text-align: center">std_srvs::Empty</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:19.348534201954397%;"><div style="text-align: center">std_srvs::Empty</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:21.693811074918568%;"><div style="text-align: center">std_srvs::Empty</div></td><td style="border: 1px solid rgb(211, 211, 211); padding: 10px; margin: 0px;width:14.65798045602606%;"><div style="text-align: center">std_srvs::Empty</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Request</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><span style="font-size: 14px;">-</span></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><span style="font-size: 14px;">-</span></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><span style="font-size: 14px;">-</span></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><span style="font-size: 14px;">-</span></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><span style="font-size: 14px;">-</span></div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Response</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><span style="font-size: 14px;">-</span></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">-</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">-</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">-</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">-</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Description</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><br/></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><br/></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><br/></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><br/></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><br/></div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Variable name</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">startControl_</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">stopControl_</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">clearCommands_</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">hover_</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">lockScaleFP_</div></td></tr><tr><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center"><b>Callback</b></div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setReference()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setMaxControl()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setInitialReachDistance()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setStayWithinDistance()</div></td><td style="border-style:solid;border-width:1px;border-color:rgb(211,211,211);padding:10px;margin:0px;width:16.67%;"><div style="text-align: center">setStayTime()</div></td></tr></tbody></table><div><b><br/></b></div><div><br/></div><div><hr/></div><div><br/></div><div>Parameter</div><div>~minPublishFreq &lt;-- 누가 set해주나? Float형식. set해놓은게 없으면기본값 110</div><div><br/></div><div><span style="font-size: 32px;"><b>Reconfigurable parameters</b></span></div><div><b><br/></b></div><div><br/></div><div><span style="font-size: 19px;"><b>&lt;tum_ardrone/<span style="color: rgb(255, 102, 0);">AutopilotParamsConfig.h</span>&gt;</b></span></div><div><br/></div><div><b><span style="font-size: 16px;">AutopilotParams.cfg 내용</span></b></div><div><br/></div><div>gen.add(&quot;<b>Ki_yaw</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.0</b>, 0.0, 1.0)</div><div>gen.add(&quot;<b>Kd_yaw</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.00</b>, 0.0, 1.0)</div><div>gen.add(&quot;<b>Kp_yaw</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.05</b>, 0.0, 1.0)</div><div>gen.add(&quot;<b>max_yaw</b>&quot;, double_t, 0, &quot;Max. Yaw control sent (ever)&quot;, <b>1.0</b>, 0.0, 1.0)</div><div><br/></div><div>gen.add(&quot;<b>Ki_gaz</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.001</b>, 0.0, 1.0)</div><div>gen.add(&quot;<b>Kd_gaz</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.1</b>, 0.0, 1.0)</div><div>gen.add(&quot;<b>Kp_gaz</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.6</b>, 0.0, 1.0)</div><div><br/></div><div>gen.add(&quot;<b>rise_fac</b>&quot;, double_t, 0, &quot;positive gaz values are multiplied by this&quot;, <b>2.5</b>, 0.0, 5.0)</div><div>gen.add(&quot;<b>max_gaz_rise</b>&quot;, double_t, 0, &quot;max. (positive) gaz control sent.&quot;, <b>0.8</b>, 0, 1.0)</div><div>gen.add(&quot;<b>max_gaz_drop</b>&quot;, double_t, 0, &quot;max. (negative) gaz control sent.&quot;, <b>-0.25</b>, -1.0, 0.0)</div><div><br/></div><div>gen.add(&quot;<b>Ki_rp</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.0</b>, 0.0, 1.0)</div><div>gen.add(&quot;<b>Kd_rp</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.35</b>, 0.0, 1.0)</div><div>gen.add(&quot;<b>Kp_rp</b>&quot;, double_t, 0, &quot;PID control parameter&quot;, <b>0.5</b>, 0.0, 1.0)</div><div>gen.add(&quot;<b>max_rp</b>&quot;, double_t, 0, &quot;max roll/pitch control sent.&quot;, <b>1.0</b>, 0.0, 1.0)</div><div><br/></div><div>gen.add(&quot;<b>agressiveness</b>&quot;, double_t, 0, &quot;global multiplyer to PI control.&quot;, <b>1.0</b>, 0.0, 5.0)</div><div><b><br/></b></div><hr/><div><b><br/></b></div><div>노드 변수</div><div><b><br/></b></div><div><b>Publisher </b><br clear="none"/></div><div><br clear="none"/></div><div>ros::Publisher <b>vel_pub</b></div><div><span style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">ros::Publisher</span> <b>tum_ardrone_pub</b></div><div><span style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">ros::Publisher</span> <b>takeoff_pub</b></div><div><span style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">ros::Publisher</span> <b>land_pub</b></div><div><span style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">ros::Publisher</span> <b>toggleState_pub</b></div><div><br clear="none"/></div><div><b>Subscriber </b></div><div><br/></div><div>ros::Subscriber <b>dronepose_sub</b></div><div>ros::Subscriber <b>tum_ardrone_sub</b></div><div><br/></div><div><b>parameters</b></div><div><b><br/></b></div><div><b># 생성자 호출시 전부 사용됨. </b></div><div>int <b>minPublishFreq</b>;</div><div># 이하는 메세지 발행자/구독자 리소스 네임을 위한 문자열 변수</div><div>std::string <b>control_channel</b>;</div><div>std::string <b>dronepose_channel</b>;</div><div>std::string <b>command_channel</b>;</div><div>std::string <b>packagePath</b>;</div><div>std::string <b>land_channel</b>;</div><div>std::string <b>takeoff_channel</b>;</div><div>std::string <b>toggleState_channel</b>;</div><div><b><br/></b></div><hr/><div><b><br/></b></div><div>함수</div><div><br/></div><div>콜백함수</div><div><br/></div><div><span style="color: rgb(50, 135, 18);"># 패키지 자체 생성 서비스 콜백</span></div><div>bool setReference(tum_ardrone::SetReference::Request&amp;, tum_ardrone::SetReference::Response&amp;);</div><div>bool setMaxControl(tum_ardrone::SetMaxControl::Request&amp;, tum_ardrone::SetMaxControl::Response&amp;);</div><div>bool setInitialReachDistance(tum_ardrone::SetInitialReachDistance::Request&amp;, tum_ardrone::SetInitialReachDistance::Response&amp;);</div><div>bool setStayWithinDistance(tum_ardrone::SetStayWithinDistance::Request&amp;, tum_ardrone::SetStayWithinDistance::Response&amp;);</div><div>bool setStayTime(tum_ardrone::SetStayTime::Request&amp;, tum_ardrone::SetStayTime::Response&amp;);</div><div><br/></div><div><span style="color: rgb(50, 135, 18);"># 표준 Empty 타입 서비스 콜백</span></div><div>bool start(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;);</div><div>bool stop(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;);</div><div>bool clear(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;);</div><div>bool hover(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;);</div><div>bool lockScaleFP(std_srvs::Empty::Request&amp;, std_srvs::Empty::Response&amp;);</div><div><br/></div><div><b><br/></b></div><hr/><div><b><br/></b></div><div><b>생성자</b></div><div><b><br/></b></div><div><b>그래픽 리소스 네임 정의</b></div><div><b><br/></b></div><div>name resolution : 디폴트 네임스페이스가 &quot;/&quot;인 경우 (따로 설정하지 않았을 때), 앞에 &quot;/&quot;만 붙여준 것이 실제 리소스네임이 됨.</div><div><br/></div><div>노드이름</div><div>/drone_autopilot</div><div><br/></div><div><br/></div><div><hr/></div><div>내부변수들</div><div><br/></div><div>packagePath # </div><div><br/></div><div>logfileControl</div><div><br/></div><div>&lt;ControlCommand 클래스&gt;</div><div>hoverCommand.gaz</div><div>hoverCommand.pitch </div><div>hoverCommand.roll </div><div>hoverCommand.yaw</div><div>lastControlSentMS</div><div><br/></div><div><b>    parameter_referenceZero = DronePosition(TooN::makeVector(0,0,0),0);</b></div><div><b>    parameter_MaxControl = 1;</b></div><div><b>    parameter_InitialReachDist = 0.2;</b></div><div><b>    parameter_StayWithinDist = 0.5;</b></div><div><b>    parameter_StayTime = 2;</b></div><div><b>    isControlling = false;</b></div><div><b>    currentKI = NULL;</b></div><div><b>    lastSentControl = ControlCommand(0,0,0,0);</b></div><div><b><br/></b></div><div><hr/></div><div><b>커맨드 (총 14개)</b></div><div><b><br/></b></div><div><b>Global command</b></div><div><br/></div><div>toggleLog (ControlNode::toogleLogging())</div><div><b><br/></b></div><div><b>c command</b></div><div><b><br/></b></div><div><b>KI 계열</b></div><div>&lt;KIAutoInit&gt;  autoInit  /  autoTakeover  /  takeoff</div><div>&lt;KIFlyTo&gt;     goto  /  moveBy  /  moveByRel</div><div>&lt;KILand&gt;      land</div><div><br/></div><div><b>일반 명령어</b></div><div><b><br/></b></div><div>&lt;단순 함수 호출&gt; start / stop / clearCommands</div><div>&lt;parameter_변수 설정&gt; setOffset  / setMaxControl  /  setInitialReachDist  /  setStayWithinDist  / setStayTime  </div><div>&lt;publishCommand&gt; lockScaleFP</div><div><br/></div><div>void ControlNode::comCb(const std_msgs::StringConstPtr str)</div><div>void ControlNode::droneposeCb(const tum_ardrone::filter_stateConstPtr statePtr)</div><div><br/></div><div><br/></div><div>커맨드 전달 시퀀스 ( comCb() -&gt; commandQueue -&gt; droneposeCb() -&gt; popNextCommand() -&gt; droneposeCb() )</div><div><br/></div><div><b>1.comCb()</b></div><div>/tum_ardrone/com 토픽을 구독하는 콜백함수. 토픽 발행시마다 커맨드 문자열의 참조(std_msgs::StringConstPtr)를 받음.</div><div>'c '로 시작하는 커맨드 start / stop / clearCommands로 시작하는 경우 바로 해당 함수 실행. (startControl() / stopControl() / clearCommands())</div><div>'c '없이 바로 시작하는 전역 커맨드 toggleLog의 경우도 해당 함수 실행. (toogleLogging())</div><div>나머지 모든 커맨드는 commandQueue에 계속해서 집어 넣음. (drone_gui 노드에서 발행할 때마다)</div><div><br/></div><div><b>2.droneposeCb()</b></div><div>/ardone/predictedPose 토픽을 구독하는 콜백함수. 토픽 발행시마다 칼만필터 결과값의 참조(tum_ardrone::filter_stateConstPtr)를 받음.</div><div>현재 commandQueue에 쌓여있는 대기열에서 차례로 커맨드를 꺼내서 실행을 함. (popNextCommand(statePtr))</div><div><br/></div><div><b>3.popNextCommand()</b></div><div>droneposeCb() 내부에서 콜되는 함수. 콜될 때마다 대기열에서 커맨드를 꺼냄.</div><div>pose와 reference에 관련된 파라미터를 갖는 커맨드의 경우에는 filter_state의 맴버 변수인 x,y,z,yaw를 읽어와서 파라미터 위치에 붙여줌.</div><div>KI커맨드의 경우에는 currentKI에 KI를 동적할당하고 그 주소를 반환.</div><div>set커맨드의 경우에는 parameter_변수에 설정값 저장.</div><div>setScaleFP의 경우는 특별하게 publishCommand(&quot;p lockScaleFP&quot;) 수행.</div><div>명령이 끝나면 다시 droneposeCb()로 돌아옴.</div><div><br/></div><div><b>4.droneposeCb()</b></div><div>popNextCommand()로 커맨드를 하나씩 꺼내다가 KI 커맨드가 나오면 컨트롤을 업데이트해줌(updateControl(statePtr) -&gt; update(statePtr)).</div><div>아직 stop 명령어를 받지 않은 상태에서 큐를 모두 비웠을 경우-다음으로 할일이 없을때-에는 호버링 명령 전송 (sendControlToDrone(hoverCommand)).</div><div><br/></div><div><b>5.update()</b></div><div>ControlNode 객체의 주소. ControlNode에서 선언한 DroneController 객체의 주소.</div><div><br/></div><div><br/></div><div><b>6.sendControlToDrone()</b></div><div><span style="color: rgb(255, 0, 0);">*<b>추후 수정해야하는 주요 함수!</b></span></div><div><span style="color: rgb(255, 0, 0);">*이 함수에서 ardrone_autonomy노드가 구독하는 컨트롤 값인 /cmd_vel을 발행.</span></div><div>double형 roll, pitch, yaw, gaz를 멤버변수로 갖는ControlCommand 구조체를 인수로 받음.</div><div>ControlCommand -&gt; geometry_msgs::Twist 타입으로 변환</div><div>드론의 rc 컨트롤(쓰로틀/기울기제어) -&gt; 3축의 각/선속도로 변환</div><div><br/></div><div>    geometry_msgs::Twist cmdT;</div><div><br/></div><div>    cmdT.angular.z = -cmd.yaw;</div><div>    cmdT.linear.z = cmd.gaz;</div><div>    cmdT.linear.x = -cmd.pitch;</div><div>    cmdT.linear.y = -cmd.roll;</div><div><br/></div><div><span style="color: rgb(50, 135, 18);">    // 안쓰는 속도값. 호버링 모드 사용하려면 0으로 셋.</span></div><div>    cmdT.angular.x = cmdT.angular.y = 0; </div><div><br/></div><div>    if(isControlling)</div><div>    {</div><div>        <span style="color: rgb(250, 122, 0);">vel_pub.publish(cmdT)</span>;   <span style="color: rgb(50, 135, 18);">// 토픽 /cmd_vel로 발행</span></div><div>        lastSentControl = cmd;</div><div>    }</div><div><br/></div><div>    lastControlSentMS = getMS(ros::Time::now());</div><div><br/></div><div><hr/></div><div><br/></div><div><b>publishCommand() 전송 내용</b></div><div><br/></div><div>void ControlNode::publishCommand(std::string c)</div><div>{</div><div>    std_msgs::String s;</div><div>    s.data = c.c_str();</div><div>    pthread_mutex_lock(&amp;tum_ardrone_CS);</div><div>    tum_ardrone_pub.publish(s);</div><div>    pthread_mutex_unlock(&amp;tum_ardrone_CS);</div><div>}</div><div><br/></div><div>p lockScaleFP</div><div>p space                     // press space</div><div><br/></div><div>f reset                       // reset whole filter.</div><div><br/></div><div>u l Autopilot: Start Controlling</div><div>u l Autopilot: Stop Controlling</div><div>u l Autopilot: Cleared Command Queue</div><div>u l New Target: xyz = %.3f, %.3f, %.3f,  yaw=%.3f&quot;, target.pos[0],target.pos[1],target.pos[2],target.yaw</div><div><br/></div><div><br/></div><div>// reSendInfo()에서 발행</div><div>u c %s (Queue: %d)\n                                        // isControlling ? &quot;Controlling&quot; : &quot;Idle&quot;,  (int)commandQueue.size()</div><div>Current: %s\n                                                    // currentKI == NULL ? &quot;NULL&quot; : currentKI-&gt;command.c_str()</div><div>Next: %s\n                                                         // commandQueue.size() &gt; 0 ? commandQueue.front().c_str() : &quot;NULL&quot;  </div><div>Target: (%.2f,  %.2f,  %.2f), %.1f\n                    // p.pos[0],p.pos[1],p.pos[2],p.yaw,</div><div>Error: (%.2f,  %.2f,  %.2f), %.1f (|.| %.2f)\n       // e[0],e[1],e[2],e[3], ea,</div><div>Cont.: r %.2f, p %.2f, g %.2f, y %.2f                    // lastSentControl.roll, lastSentControl.pitch, lastSentControl.gaz, lastSentControl.yaw</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><b><br/></b></div></span>
</div></body></html> 