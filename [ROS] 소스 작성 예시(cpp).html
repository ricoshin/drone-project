<html>
<head>
  <title>[ROS] 소스 작성 예시(cpp)</title>
  <basefont face="나눔고딕" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303244 (ko-KR, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 나눔고딕;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1348"/>
<h1>[ROS] 소스 작성 예시(cpp)</h1>

<div><span><div><span style="font-family: gotham;"><span style="font-size: 14px;"><strong>src</strong>/oroca_ros_tutorials/<strong>msg</strong>/msgTutorial.<strong>msg</strong> ----&gt; </span>(gencpp) ----&gt; <strong>devel/include</strong>/oroca_ros_tutorials/msgTutorial.<strong>h</strong></span></div><div><span style="font-family: gotham;">                      (msg 파일)                                                                                        (헤더 파일)</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">#include &lt;ros/ros.h&gt; // ROS 기본 헤더파일 <span style="color: rgb(51, 153, 102); font-size: 14px;">(전체경로) /opt/ros/indigo/include/ros/ros.h</span></span></div><div><span style="font-family: gotham;">#include &lt;std_msgs/String.h&gt;</span></div><div><span style="font-family: gotham;">#include &lt;sstream&gt; #string stream</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">#include &quot;oroca_ros_tutorials/srvTutorial.h&quot; <span style="color: #339966;">// (workspace경로) ~/catkin_ws/devel/include/oroca_ros_tutorials/msgTutorial.h</span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">ros::init(argc, argv, &quot;ros_tutorial_xxx_xxxxx&quot;); <span style="color: #339966;">// 노드명 초기화</span></span></div><div><span style="font-family: gotham;">ros::NodeHandle <span style="color: #ff0000;"><strong>nh</strong></span>; <span style="color: #339966;">// 노드 핸들 선언 (노드를 등록하기 위한 핸들)</span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><hr/></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong><span style="color: rgb(51, 153, 102); font-size: 14px;">// 메세지 (퍼블리셔)</span></strong></span></div><div><span style="font-family: gotham;"><span style="font-size: 14px;">ros::<strong>Publisher</strong> <span style="color: #ff99cc;">ros_tutorial_pub</span> = <strong><span style="color: #ff0000;">nh</span>.advertise</strong><span style="color: #3366ff;"><strong><span style="color: #000000;">&lt;</span>oroca_ros_tutorials::msgTutorial<span style="color: #000000;">&gt;</span></strong></span>(&quot;<span style="color: #ff9c00;">ros_tutorial_msg/jjj</span>&quot;, 100); </span></span></div><div><span style="font-family: gotham;"><span style="font-size: 14px;"><span style="color: #3366ff;"><strong>oroca_ros_tutorials::msgTutorial</strong> </span></span><span style="font-size: 14px;"><span style="color: #339966;"><span style="color: #ff6600;"><strong>msg</strong></span><span style="color: #000000;">;</span></span></span></span></div><div><span style="font-family: gotham;"><span style="font-size: 14px;"><span style="color: #339966;"><span style="color: #ff6600;"><strong>msg</strong></span><span style="color: #000000;">.data = 10;</span></span></span></span></div><div><span style="font-family: gotham;"><span style="font-size: 14px;"><span style="color: #ff99cc;">ros_tutorial_pub</span>.publish(<span style="color: #ff6600;"><strong>msg</strong></span>); </span><span style="color: rgb(51, 153, 102); font-size: 14px;">// &lt;---- <strong>퍼블리셔</strong> 쪽에서 메세지 발행(10을 보냄)</span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong><span style="color: rgb(51, 153, 102); font-size: 14px;">// 메세지 (서브스크라이버)</span></strong></span></div><div><span style="font-family: gotham;">ros::<strong>Subscriber</strong> ros_tutorial_sub = <strong><span style="color: #ff0000;">nh</span></strong>.<strong>subscribe</strong>(&quot;<span style="color: #ff9c00;">ros_tutorial_msg/jjj</span>&quot;, 10, <strong><span style="color: #cc99ff;">msgCallback</span></strong>); <span style="color: rgb(51, 153, 102); font-size: 14px;">// 메세지 타입은 퍼블리셔에 따르므로 생략</span></span></div><div><span style="font-family: gotham;"><span style="font-size: 14px;">ros::spin(); </span><span style="color: rgb(51, 153, 102); font-size: 14px;">// 메세지 수신 대기, 수신되면 콜백함수 실행</span></span></div><div><span style="font-family: gotham;">void <strong><span style="color: #cc99ff;">msgCallback</span></strong>(<span style="color: #3366ff;"><span style="color: #000000;">const</span> <strong>oroca_ros_tutorials::msgTutorial</strong></span>::ConstPtr&amp; <strong><span style="color: #ff6600;">msg</span></strong>){</span></div><div><span style="font-family: gotham;">     ROS_INFO(&quot;receive <strong><span style="color: #ff6600;">msg</span></strong>: %d&quot;, <strong><span style="color: #ff6600;">msg</span></strong>-&gt;data); <span style="color: rgb(51, 153, 102); font-size: 14px;">// 메세지 발행되면 콜백함수 실행</span></span></div><div><span style="font-family: gotham;">}</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><hr/></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong><span style="color: rgb(51, 153, 102); font-size: 14px;">// 서비스(서버)</span></strong></span></div><div><span style="font-family: gotham;">ros::<strong>ServiceServer</strong> ros_tutorial_service_server = <strong><span style="color: #ff0000;">nh</span></strong>.<strong>advertiseService</strong>(&quot;<span style="color: #ff6600;">ros_tutorial_srv</span>&quot;, <strong><span style="color: #cc99ff;">calculation</span></strong>); <span style="color: rgb(51, 153, 102); font-size: 14px;">// 메세지 타입은 클라이언트에 따름</span></span></div><div><span style="font-family: gotham;">ros::spin(); <span style="color: rgb(51, 153, 102); font-size: 14px;">// 서비스 요청 대기</span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">bool <strong><span style="color: #cc99ff;">calculation</span></strong>(<span style="color: #99cc00;"><strong><span style="color: #808000;">oroca_ros_tutorials::srvTutorial</span><span style="color: #000000;">::</span><span style="color: #993300;">Request</span></strong></span> &amp;<span style="color: #ff6600;"><strong>req</strong></span>, <strong><span style="color: #33cccc;"><span style="color: #808000;">oroca_ros_tutorials::srvTutorial</span><span style="color: #000000;">::</span><span style="color: #0000ff;">Response</span></span></strong> &amp;<span style="color: #00ccff;"><strong>res</strong></span>){</span></div><div><span style="font-family: gotham;">     <span style="color: #00ccff;"><strong>res</strong></span>.result = <span style="color: #ff6600;"><strong>req</strong></span>.a + <span style="color: #ff6600;"><strong>req</strong></span>.b; <span style="color: rgb(51, 153, 102); font-size: 14px;">// 서비스 요청이 오면 콜백 함수 실행</span></span></div><div><span style="font-family: gotham;">     return true;</span></div><div><span style="font-family: gotham;">}</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong><span style="color: rgb(51, 153, 102); font-size: 14px;">// 서비스(클라이언트)</span></strong></span></div><div><span style="font-family: gotham;">ros::<strong>ServiceClient</strong> <span style="color: #ff99cc;">ros_tutorial_service_client</span> = <strong><span style="color: #ff0000;">nh</span></strong>.<strong>serviceClient&lt;<span style="color: #808000;">oroca_ros_tutorials::srvTutorial</span>&gt;</strong>(&quot;<span style="color: #ff6600;">ros_tutorial_srv</span>&quot;);</span></div><div><span style="font-family: gotham;"><strong style="font-size: 14px;"><span style="color: #0000ff;"><span style="color: #808000;">oroca_ros_tutorials::srvTutorial</span> </span></strong><span style="color: rgb(0, 128, 128); font-size: 14px;"><strong>srv<span style="color: #000000;">;</span></strong></span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">if(<span style="color: #ff99cc;">ros_tutorial_service_client</span>.call(<span style="color: #008080;"><strong>srv</strong></span>)){ <span style="color: rgb(51, 153, 102); font-size: 14px;">// &lt;---- <strong>클라이언트</strong> 쪽에서 서비스 호출 / 응답없으면 false, 있으면 true </span></span></div><div><span style="font-family: gotham;">     ROS_INFO(&quot;[send] a and b: %ld, %ld&quot;, (long int)<strong><span style="color: #008080;">srv</span>.<span style="color: #ff6600;">request</span>.a</strong>, (long int)<strong><span style="color: #3366ff;"><span style="color: #008080;">srv</span>.</span><span style="color: #ff6600;">request</span>.b</strong>);</span></div><div><span style="font-family: gotham;">     ROS_INFO(&quot;[receive] result : %ld&quot;, (long int)<strong><span style="color: #008080;">srv</span>.<span style="color: #00ccff;">response</span>.result</strong>);</span></div><div><span style="font-family: gotham;">}else{</span></div><div><span style="font-family: gotham;">     ROS_ERROR(&quot;Failed to call service!&quot;);</span></div><div><span style="font-family: gotham;">     return 1;</span></div><div><span style="font-family: gotham;">}</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><hr/></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">while(ros::ok()){}</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">ros::Rate loop_rate(10); <span style="color: #339966;">// 루프주기 10Hz, 0.1초 간격으로 반복</span></span></div><div><span style="font-family: gotham;">loop_rate.sleep();</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">std_msgs::String msg;  <span style="color: #339966;">// std_msgs의 String 형식으로 msg 선언</span></span></div><div><span style="font-family: gotham;">oroca_ros_tutorials::msgTutorial msg; <span style="color: #339966;">// msgTutorial형식(사용자 정의)으로 msg 선언</span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">std::stringstream ss;</span></div><div><span style="font-family: gotham;">ss &lt;&lt; &quot;hello world&quot;;</span></div><div><span style="font-family: gotham;">msg.data = ss.str();</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">ros::spinOnce();</span></div><div><span style="font-family: gotham;">ros::spin(); <span style="color: #339966;">// 콜백함수 호출 함수로서, 메세지 수신을 대기, 수신되었을 때 콜백함수 실행 / 서비스 메시지의 경우 서비스 요청을 대기</span></span></div><div><span style="font-family: gotham;"><span style="color: #339966;">               </span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">ROS_INFO(&quot;%s&quot;, msg.data.c_str());</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><hr/></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong>ros::spin()과 ros::spinOnce()의 차이</strong></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong>처리시퀀스</strong></span></div><div><span style="font-family: gotham;">백그라운드에서 ROS는 당신이 구독한 모든 토픽에 대해서 소켓 연결을 모니터링하고 있다.</span></div><div><span style="font-family: gotham;">메시지가 도착했을때, ROS는 당신의 구독자 콜백을 큐에 푸쉬한다. 그러나 즉각적으로 처리되지는 않는다.</span></div><div><span style="font-family: gotham;">당신이 ros::spinOnce()를 호출할 때만 ROS가 당신의 콜백을 처리할 것이다.</span></div><div><span style="font-family: gotham;">ros::spin은 단순히 편리함을 위한 것이다. ROS의 메인루프가 노드가 셧다운 될 때까지 반복해서 ros::spinOnce()를 호출한다.</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong>ros::spin()</strong>은 노드가 shutdown될 때까지 리턴하지 않는다. ROS가 spinning하는 동안 프로그램에 대한 컨트롤을 상실하게 됨.</span></div><div><span style="font-family: gotham;"><strong>ros::spinOnce()</strong>는 당신이 호출할 때마다 그때 그때 콜백이나 서비스 콜 등을 체크한다.</span></div><div><span style="font-family: gotham;">ROS가 업데이트를 하는 주기를 제어할 수 있기 때문에 특정 빈도로 어떤 계산을 수행하고자 할 때 유용하다.</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">예를 들어, 센서에서 100Hz로 데이터를 샘플링해서 보내준다고 할 때, 센서값이 업데이트 될 때마다 당신의 프로그램에서 콜백이 등록된다.</span></div><div><span style="font-family: gotham;">이것은 당신의 프로그램이 1초당 100번 센서 데이터를 처리하고 있다는 것을 의미한다.</span></div><div><span style="font-family: gotham;">만약 당신이 데이터를 1초당 5번(5Hz)만 읽어서 파일에 저장하고 싶다고 해보자.</span></div><div><span style="font-family: gotham;">ros::spin()을 사용한다면 당신의 프로그램은 선택의 여지가 없이 1초에 100번 콜백 함수를 처리해야한다.</span></div><div><span style="font-family: gotham;">그러나 ros::spinOnce()를 사용한다면 당신이 원하는 빈도 만큼 콜백을 호출하는 것이 가능하다.</span></div><div><span style="font-family: gotham;">보통 while(ros::ok()) 문에서 ros::Rate 객체를 선언해서 주기를 조절하고 매 루프마다 ros::spinOnce()를 수행하는 방식으로 처리한다.</span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><hr/></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong>서비스 요청시 호출하는 ROS shell 명령어(rosrun vs russervice)</strong></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;">$ rosrun oroca_ros_tutorials ros_tutorial_srv_client 10 5</span></div><div><span style="font-family: gotham;"><span style="color: #339966;">[ INFO] [1468545192.298211197]: send srv, srv.Request.a and b: 10, 5</span></span></div><div><span style="font-family: gotham;"><span style="color: #339966;">[ INFO] [1468545192.298280764]: receive srv, srv.Response.result : 15</span></span></div><div><span style="font-family: gotham;"><span style="color: #339966;"><br clear="none"/></span></span></div><div style="font-size: 14px;"><span style="font-family: gotham;">$ rosservice call /ros_tutorial_srv 10 5</span></div><div style="font-size: 14px;"><span style="font-family: gotham;"><span style="color: #339966;">result: 15</span></span></div><div style="font-size: 14px;"><span style="font-family: gotham;"><br clear="none"/></span></div><div style="font-size: 14px;"><span style="font-family: gotham;">rosrun으로 노드자체를 실행시키는 경우, 프로그램 전체 시퀀스를 모두 수행하는 것에 포커스.</span></div><div style="font-size: 14px;"><span style="font-family: gotham;">rosservice로 서비스 콜 자체에 포커스. 서비스 response의 결과만 보여줌.</span></div><div style="font-size: 14px;"><span style="font-family: gotham;"><span style="color: #339966;"><br clear="none"/></span></span></div><div><hr/></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong>매개변수 사용 (ROS shell 명령어 vs 소스코드)</strong></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong>파라미터 설정</strong></span></div><div><span style="font-family: gotham;"><span style="color: #808080;"><em>(ROS shell)</em></span></span></div><div><span style="font-family: gotham;">$rosparam set /<span style="color: #3366ff;">my_param</span> 10</span></div><div><span style="font-family: gotham;"><span style="color: #808080;"><em>(코드레벨)</em></span></span></div><div><span style="font-family: gotham;">ros::NodeHandle <span style="color: #ff6600;">nh</span>;</span></div><div><span style="font-family: gotham;"><span style="color: #ff6600;">nh</span>.setParam(&quot;<span style="color: #3366ff;">my_param</span>&quot;, 10); <span style="color: #008000;">// 매개변수 /my_param에  정수 10 저장</span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><span style="font-family: gotham;"><strong>파라미터 읽기</strong></span></div><div><span style="font-family: gotham;"><span style="color: #808080;"><em>(ROS shell)</em></span></span></div><div><span style="font-family: gotham;">$rosparam get /<span style="color: #3366ff;">my_param</span></span></div><div><span style="font-family: gotham;"><span style="color: #808080;"><em>(코드레벨)</em></span></span></div><div><span style="font-family: gotham;">int <span style="color: #cc99ff;">my_var</span>;</span></div><div><span style="font-family: gotham;">ros::NodeHandle <span style="color: #ff6600;">nh</span>;</span></div><div><span style="font-family: gotham;"><span style="color: #ff6600;">nh</span>.getParam(&quot;<span style="color: #3366ff;">my_param</span>&quot;, <span style="color: #cc99ff;">my_var</span>); <span style="color: #008000;">// 변수 my_var에 /my_param값 로드</span></span></div><div><span style="font-family: gotham;"><br clear="none"/></span></div><div><hr/></div><div><br clear="none"/></div></span>
</div></body></html> 