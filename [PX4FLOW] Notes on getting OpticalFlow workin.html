<html>
<head>
  <title>[PX4FLOW] Notes on getting OpticalFlow working with Copter v3.3.</title>
  <basefont face="나눔고딕" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303244 (ko-KR, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 나눔고딕;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1876"/>
<h1>[PX4FLOW] Notes on getting OpticalFlow working with Copter v3.3.</h1>

<div>
<span><div><a href="http://diydrones.com/forum/topics/optical-flow-discussion-thread?id=705844%3ATopic%3A2135599&amp;page=2#comments">http://diydrones.com/forum/topics/optical-flow-discussion-thread?id=705844%3ATopic%3A2135599&amp;page=2#comments</a></div><div><br/></div><div>Just in case it might be useful to someone trying to get OF to work, here's a copy of my notes on getting OpticalFlow working with Copter v3.3.</div><div><br/></div><div>I have it kinda/sorta working (with some intermittent issues), and I'm not 100% sure if everything is setup correctly and I'm sure I've missed something, so any feedback will be greatly appreciated.</div><div><br/></div><div>Thanks!</div><div><br/></div><div><br/></div><div>Download PX4FLOW Firmware</div><div><br/></div><div>Download the APM's version of PX4FLOW Firmware from: http://ardupilot.com/downloads/?did=118</div><div>(The expanded firmware should be px4flow-klt-06Dec2014.px4)</div><div><br/></div><div>Flash PX4FLOW firmware</div><div>◾Connect PX4Flow to PC via USB</div><div>◾Make sure I2C cable between PX4FLOW and Pixhawk is disconnected.</div><div>◾Use QGroundControl to load the binary firmware downloaded in the previous section.</div><div><br/></div><div>NOTE: Some versions of QGroundControl are missing the menu to upload custom firmware from local filesystem. Use the latest version (v2.8.0) in order to upload the custome firmware to PX4FLOW. v2.8.0 also has PX4FLOW specific settings menu with auto-video streaming. If you want to run an older version of QGroundControl, use v2.5.2 or earlier in order to be able to load custom firmware to PX4FLOW.</div><div><br/></div><div>All release versions of QGroundControl can be found here</div><div><br/></div><div>Adjust PX4FLOW</div><div>◾Connect PX4FLOW to QGroundControl via USB.</div><div>◾With the latest version of QGroundControl, video is automatically streamed and displayed in the PX4FLOW specific settings menu.</div><div>◾From the parameters menu, set VIDEO_ONLY=1 in order to view high-resolution video for adjusting lens focus.</div><div>◾While view the video stream via USB, twist the focus ring on the PX4FLOW lens so that the image is focused and edges are sharp at around 3 meters (or your average hovering height, which is 1m in my case).</div><div>◾Tighten the focus ring screw once focus has been adjusted.</div><div>◾Disable high-resolution video streaming mode by setting VIDEO_ONLY parameter to 0.</div><div><br/></div><div>Connect PX4FLOW to Pixhawk/PXF</div><div>◾Use DF13 4 pos connector to connect I2C port of PX4FLOW to I2C port of Pixhawk/PXF.</div><div>◾If you want to use the sonar on-board PX4FLOW, use analog pins and connect it to ADC input of Pixhawk (details to be filled).</div><div><br/></div><div>Update Copter Firmware</div><div>◾Minimum version you need in order to use OF is Copter v3.3.1 + https://github.com/diydrones/ardupilot/commit/9b80ab18ae57dc38f1b91...</div><div>◾You can also run Copter v3.3.2-rc2 or later which has above changes included.</div><div>◾In both cases, you need to build the APM:Copter firmware from the source and flash Pixhawk with it.</div><div><br/></div><div>Configure OpticalFlow</div><div><br/></div><div>Via APM Planner 2.0 / Mission Planner</div><div>◾Initial Setup -&gt; Optional Setup -&gt; Optical Flow -&gt; Check the &quot;Enable&quot; checkbox</div><div>◾Cofig/Tuning -&gt; Full Parameter List</div><div><br/></div><div>Change the following parameters:</div><div>EKF_GPS_TYPE -&gt; 3</div><div>FLOW_ENABLE -&gt; 1</div><div>FLOW_FXSCALER -&gt; 0</div><div>FLOW_FYSCALER -&gt; 0</div><div>FLOW_ORIENT_YAW -&gt; 0 if you've mounted PX4FLOW's x axis facing forward (xyz axis marker is printed on the backside of PX4FLOW PCB board). If x is not facing forward, adjust this. Value Must be between -18000 and 18000 centidegrees.</div><div><br/></div><div># Disable GPS pre-arm check</div><div>GPS_HDOP_GOOD -&gt; 9999</div><div># Enable Pre-ARM Logging (All + FastATT, including pre-arm logging)</div><div>LOG_BITMASK -&gt; 131071</div><div><br/></div><div># If you want to use built-in barometer instead of external range finder (NOT recommended).</div><div>EKF_ALT_SOURCE -&gt; 0 # Set this to 1 if you have external range finder (LiDAR, etc.)</div><div>RNGFND_GNDCLEAR -&gt; set this according to your rangefinder's spec.</div><div><br/></div><div>Testing</div><div><br/></div><div>Check mount orientation and tweak the scaler parameters according to the instructions in the wiki</div><div><br/></div><div>Check dataflash logs (NOT telemetry logs) and make sure:</div><div>◾OF.flowX, OF.flowY, OF.bodyX, OF.bodyY are responding to aircraft movements.</div><div>◾EKF5.meaRng is not flat-lined and responding to height changes.</div><div>◾EKF5.FIX and EKF5.FIY are not flat-lined (flat-line indicates OF readings are not used in EKF).</div><div>◾EKF4.SS bit 7 is false (inidicates constant position mode when true)</div><div>◾EKF4.SS bit 3 is true (indicates relative position mode when true)</div><div><br/></div><div>NOTE: OF.flowX and OF.flowY don't get updated in the telemetry log, so make sure to check the dataflash logs.</div><div>NOTE: Don't use OF_LOITER mode as they've been removed a long time ago from the firmware. APM Planner 2.0 still has this mode in the drop-down menu, presumably in order to support older versions.</div><div><br/></div><div>Issues</div><div>◾If you don't take off immediately after arming and bring your copter to at least about 1 meter, EKF will stop using OF data and you'll be flying manually.</div><div>◾Sometimes OF drops out suddenly mid-flight when readings are off, but there's no warning or indication. Only way to know is to look at the dataflash logs.</div><div>◾When flying with OF, the aircraft starts to drift off as time goes by. It appears EKF5.FIX and EKF5.FIY gets too large over time.</div><div>◾Loiter mode feels a little &quot;sluggish&quot; compared to stabilize, etc., and it's easy to get confused and panic as it seems like the copter is not responding to your RC input at all.</div><div>◾If you are getting nothing in the logs (make sure you are looking at the dataflash logs and not the telemetry logs), fire up NSH, and issue px4flow status command to see if the PX4FLOW module is detected on I2C and the driver is loaded. You should see a bunch of readouts if it's functioning correctly and error message otherwise.</div><div>◾At least one of the PX4FLOW clones (one without the on-board sonar module, bought from China) did not work when connected via I2C. It can be very confusing as it appears to be working just fine when connected directly to the PC via USB. PX4FLOW with sonar (bought direct from 3DR) doesn't have this problem.</div><div><br/></div><div>Questions</div><div>◾Can OF be used with PosHold mode instead of Loiter mode?</div><div>◾Can the sonar on PX4FLOW can be used as range-finder?</div><div><br/></div><div>Misc. Notes</div><div>◾The PX4FLOW firmware binary APM Recommended Version above is apparently built from the source code here, but the resulting binary built from the soure does not work with APM:Copter.</div><div>◾The latest upstream version, when built from the source does not seem to work with APM:Copter. OPTICAL_FLOW.flow_comp_m_x etc. in both telemetry and dataflash logs didn't look right.</div><div>◾In both cases, the values reported by the Copter didn't look right (values were too small, biased towards one direction only, less frequently updated, etc.). Although they look OK if you connect to PX4FLOW and look at the mavlink data directly.</div><div><br/></div><div>References</div><div>◾http://copter.ardupilot.com/wiki/common-px4flow-overview/</div><div>◾http://copter.ardupilot.com/wiki/arducopter-parameters/#log_bitmask...</div><div>◾http://ardupilot.com/forum/viewtopic.php?f=111&amp;t=13672&amp;sid=...</div><div>◾https://groups.google.com/forum/#!topic/drones-discuss/VgHuSh7Yjuo</div><div>◾https://github.com/diydrones/ardupilot/issues/2832</div><div>◾https://github.com/diydrones/ardupilot/issues/1672</div><div><br/></div></span>
</div></body></html> 