<html>
<head>
  <title>[ROS drone pkg] tum_ardrone-hydro-devel</title>
  <basefont face="나눔고딕" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303244 (ko-KR, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 나눔고딕;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1577"/>
<h1>[ROS drone pkg] tum_ardrone-hydro-devel</h1>

<div><span><div style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">모르는거      _ .    ???<span style="color: rgb(0, 0, 0);">           예) nh_.ok()</span></div><div style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;"><span style="color: rgb(0, 0, 0);"><br/></span></div><div style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">tum_ardrone::filter_state DroneKalmanFilter::getPoseAt(ros::Time t, bool useControlGains)     함수(인자가 2개)</div><div style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">tum_ardrone::filter_state s = filter-&gt;getPoseAt(ros::Time().now() + predTime);                             사용 ??(근데 인자가 1개)</div><div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="color: rgb(0, 0, 0);"><br/></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="color: rgb(0, 0, 0);"><br/></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="font-size: 24px;"><span style="color: rgb(0, 0, 255);">main_stateestimation.cpp</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">EstimationNode estimator;</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">f = boost::bind(&amp;EstimationNode::dynConfCb, &amp;estimator, _1, _2);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">srv.setCallback(f);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">  estimator.ptamWrapper-&gt;startSystem();                                  </div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="color: rgb(51, 153, 102);">     EstimationNode.cpp 파일의 102 번째     ptamWrapper = new PTAMWrapper(filter, this);     필터는 칼만</span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">  estimator.mapView-&gt;startSystem();</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">  estimator.Loop();</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">  estimator.mapView-&gt;stopSystem();</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">  estimator.ptamWrapper-&gt;stopSystem();</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="font-size: 24px;"><span style="color: rgb(0, 0, 255);">EstimationNode.cpp</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;"><br/></div><div style="font-family: gotham, helvetica, arial, sans-serif;font-size:16px;"><span style="color: rgb(128, 0, 128);"><span style="font-size: 18px;">토픽이름?</span></span></div><div style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">navdata_channel = nh_.resolveName(&quot;ardrone/navdata&quot;);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">control_channel = nh_.resolveName(&quot;cmd_vel&quot;);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">output_channel = nh_.resolveName(&quot;ardrone/predictedPose&quot;);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">video_channel = nh_.resolveName(&quot;ardrone/image_raw&quot;);</div></div><div style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;">command_channel = nh_.resolveName(&quot;tum_ardrone/com&quot;);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="color: rgb(128, 0, 128);"><span style="font-size: 18px;">output, input</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	navdata_sub       = nh_.subscribe(navdata_channel, 10, &amp;EstimationNode::navdataCb, this);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	vel_sub          = nh_.subscribe(control_channel,10, &amp;EstimationNode::velCb, this);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	vid_sub          = nh_.subscribe(video_channel,10, &amp;EstimationNode::vidCb, this);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	dronepose_pub	   = nh_.advertise&lt;tum_ardrone::filter_state&gt;(output_channel,1);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	tum_ardrone_pub	   = nh_.advertise&lt;std_msgs::String&gt;(command_channel,50);</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	tum_ardrone_sub	   = nh_.subscribe(command_channel,50, &amp;EstimationNode::comCb, this);</div></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">255 라인</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">EstimationNode::Loop() </div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  pthread_mutex_lock( &amp;filter-&gt;filter_CS );</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  tum_ardrone::filter_state s = filter-&gt;getPoseAt(ros::Time().now() + predTime);               <span style="color: rgb(255, 102, 0);">필터 확인후 다시</span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  pthread_mutex_unlock( &amp;filter-&gt;filter_CS );</div></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  s.header.stamp = ros::Time().now();                    </div><div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  s.scale = filter-&gt;getCurrentScales()[0];</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  s.scaleAccuracy = filter-&gt;getScaleAccuracy();</div></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  s.ptamState = ptamWrapper-&gt;PTAMStatus;</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  s.droneState = lastNavdataReceived.state;         //?? 0~9까지 숫자로 상태 표시 (입력???)</div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">     549라인	</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">     switch(	lastNavdataReceived.state)</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">     {</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 0: status = &quot;Unknown&quot;;break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 1: status = &quot;Init&quot;; break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 2: status = &quot;Landed&quot;;break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 3: status = &quot;Flying&quot;; break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 4: status = &quot;Hovering&quot;;break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 5: status = &quot;Test&quot;; break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 6: status = &quot;Taking off&quot;;break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 7: status = &quot;Goto Fix Point&quot;; break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 8: status = &quot;Landing&quot;;break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">          case 9: status = &quot;Looping&quot;; break;</span></span></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(0, 128, 0);"><span style="font-size: 10px;">     }</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  s.batteryPercent = lastNavdataReceived.batteryPercent;</div></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="color: rgb(255, 0, 0);"><span style="font-size: 18px;">// publish!</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="font-size: 18px;"><span style="color: rgb(255, 0, 0);">토픽명 &quot;ardrone/predictedPose&quot;</span></span></div><div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  <span style="color: rgb(255, 0, 0);"><span style="font-size: 18px;">dronepose_pub.publish(s);</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">if((ros::Time::now() - lastInfoSent) &gt; ros::Duration(0.4))			//지속시간이 0.4 가 지나면 reSend  실행</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  {</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			       reSendInfo();</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			       lastInfoSent = ros::Time::now();</div></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		  }</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="font-size: 24px;"><span style="color: rgb(0, 0, 255);">DroneKalmanFilter.cpp</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="font-size: 24px;"><span style="color: rgb(0, 128, 0);">tum_ardrone::filter_state s = filter-&gt;<span style="color: rgb(255, 0, 0);">getPoseAt</span>(ros::Time().now() + predTime);</span></span></div><div><span style="font-size: 16px;"><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><br/></span></span></div><div><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="font-size: 16px;">tum_ardrone::filter_state DroneKalmanFilter::<span style="color: rgb(255, 0, 0);">getPoseAt</span>(ros::Time t, bool useControlGains)
</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// make shallow copy
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	DroneKalmanFilter scopy = <span style="color: rgb(255, 0, 0);">DroneKalmanFilter</span>(*this);                    //reset();</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// predict using this copy
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	scopy.<span style="color: rgb(128, 0, 128);"><b>predictUpTo</b></span>(getMS(t),false, useControlGains);                     //649라인 </div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// return value, and discard any changes made to scopy (deleting it)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	return scopy.getCurrentPoseSpeed();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">}</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div><span style="color: rgb(192, 192, 192);"><span style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">DroneKalmanFilter scopy = </span><span style="color: rgb(255, 0, 0);"><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans; font-size: 16px;">DroneKalmanFilter</span></span><span style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">(*this);</span>

</span></div><div style="font-family:gotham, helvetica, arial, sans-serif;font-size:14px;"><span style="color: rgb(255, 0, 0);font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>

</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">DroneKalmanFilter::<span style="color: rgb(255, 0, 0);">DroneKalmanFilter</span>(EstimationNode* n)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	scalePairs = new std::vector&lt;ScaleStruct&gt;();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	navdataQueue = new std::deque&lt;ardrone_autonomy::Navdata&gt;();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	velQueue = new std::deque&lt;geometry_msgs::TwistStamped&gt;();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	useScalingFixpoint = false;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	this-&gt;node = n;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	pthread_mutex_lock( &amp;filter_CS );
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	<span style="color: rgb(255, 0, 0);">reset</span>();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	pthread_mutex_unlock( &amp;filter_CS );
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	c1 = 0.58;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	c2 = 17.8;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	c3 = 10;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	c4 = 35;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	c5 = 10;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	c6 = 25;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	c7 = 1.4;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	c8 = 1.0;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">}</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">void DroneKalmanFilter::<span style="color: rgb(255, 0, 0);">reset</span>()
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// init filter with pose 0 (var 0) and speed 0 (var large).
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	x = y = z = yaw = PVFilter(0);
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	roll = pitch = PFilter(0);
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	lastIMU_XYZ_ID = lastIMU_RPY_ID = -1;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	predictedUpToDroneTime = 0;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	last_z_heightDiff = 0;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	scalePairsIn = scalePairsOut = 0;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// set statistic parameters to zero
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	numGoodIMUObservations = 0;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// set last times to 0, indicating that there was no prev. package.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	lastIMU_XYZ_dronetime = lastIMU_RPY_dronetime = 0;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	lastIMU_dronetime = 0;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// clear PTAM
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	clearPTAM();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// clear IMU-queus
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	navdataQueue-&gt;clear();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	velQueue-&gt;clear();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	<span style="color: rgb(255, 0, 0);">predictdUpToTimestamp </span>= getMS(ros::Time::now());
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	predictedUpToTotal = -1;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	baselineZ_Filter = baselineZ_IMU = -999999;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	baselinesYValid = false;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	node-&gt;publishCommand(&quot;u l EKF has been reset to zero.&quot;);
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">}</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="color: rgb(255, 0, 0);">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div><span style="color: rgb(153, 153, 153);"><span style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">scopy.</span><span style="color: rgb(128, 0, 128);"><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans; font-size: 16px;"><b>predictUpTo</b></span></span></span><span style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><span style="color: rgb(153, 153, 153);">(getMS(t),false, useControlGains);</span> </span>

</div><div><b><span style="color: rgb(128, 0, 128);"><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans; font-size: 16px;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span></b>

</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">void DroneKalmanFilter::<span style="color: rgb(128, 0, 128);"><b>predictUpTo</b></span>(int timestamp, bool consume, bool useControlGains)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">{
</div><div><span style="font-size: 16px;"><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;">	if(<span style="color: rgb(255, 0, 0);">predictdUpToTimestamp </span>== timestamp) return;
          //</span></span>



<span style="color: rgb(51, 153, 102);"><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans; font-size: 16px;">predictdUpToTimestamp </span><span style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">= getMS(ros::Time::now());</span>
</span>
<span style="color: rgb(255, 0, 0);font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"> </span></div><div><span style="color: rgb(51, 153, 102);"><span style="font-size: 16px;"><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;">                                                                                       //</span></span> <span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans; font-size: 16px;"><span style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">getMS(ros::Time::now())</span></span>==<span style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">getMS(t)     즉 t값이 </span>

<span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans; font-size: 16px;"><span style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">ros::Time::now() 와 같으면 리턴</span></span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">std::deque&lt;geometry_msgs::TwistStamped&gt;::iterator controlIterator = velQueue-&gt;begin();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	while(controlIterator != velQueue-&gt;end() &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			controlIterator+1 != velQueue-&gt;end() &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			getMS((controlIterator+1)-&gt;header.stamp) &lt;= predictdUpToTimestamp - delayControl)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(consume)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			velQueue-&gt;pop_front();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			controlIterator = velQueue-&gt;begin();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		}
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		else
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			controlIterator++;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	if(velQueue-&gt;size() == 0) useControlGains = false;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// dont delete here, it will be deleted if respective rpy data is consumed.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	std::deque&lt;ardrone_autonomy::Navdata&gt;::iterator xyzIterator = navdataQueue-&gt;begin();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	while(xyzIterator != navdataQueue-&gt;end() &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			getMS(xyzIterator-&gt;header.stamp) &lt;= predictdUpToTimestamp + delayXYZ)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		xyzIterator++;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	std::deque&lt;ardrone_autonomy::Navdata&gt;::iterator rpyIterator = navdataQueue-&gt;begin();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	while(rpyIterator != navdataQueue-&gt;end() &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			getMS(rpyIterator-&gt;header.stamp) &lt;= predictdUpToTimestamp + delayRPY)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(consume)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			navdataQueue-&gt;pop_front();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			rpyIterator = navdataQueue-&gt;begin();
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		}
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		else
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			rpyIterator++;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// now, each iterator points to the first elemnent in queue that is to be integrated.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	// start predicting,
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	while(true)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// predict ahead to [timestamp]
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		int predictTo = timestamp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// but a maximum of 10ms per prediction step, to guarantee nonlinearities.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		predictTo = min(predictTo, predictdUpToTimestamp+10);
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// get three queues to the right point in time by rolling forward in them.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// for xyz this is the first point at which its obs-time is bigger than or equal to [predictdUpToTimestamp]
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		while(xyzIterator != navdataQueue-&gt;end() &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				getMS(xyzIterator-&gt;header.stamp) - delayXYZ &lt; predictdUpToTimestamp)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			xyzIterator++;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		while(rpyIterator != navdataQueue-&gt;end() &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				getMS(rpyIterator-&gt;header.stamp) - delayRPY &lt; predictdUpToTimestamp)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			rpyIterator++;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// for control that is last message with stamp &lt;= predictdUpToTimestamp - delayControl.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		while(controlIterator != velQueue-&gt;end() &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				controlIterator+1 != velQueue-&gt;end() &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				getMS((controlIterator+1)-&gt;header.stamp) + delayControl &lt;= predictdUpToTimestamp)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			controlIterator++;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// predict not further than the point in time where the next observation needs to be added.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(rpyIterator != navdataQueue-&gt;end() )
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			predictTo = min(predictTo, getMS(rpyIterator-&gt;header.stamp)-delayRPY);
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(xyzIterator != navdataQueue-&gt;end() )
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			predictTo = min(predictTo, getMS(xyzIterator-&gt;header.stamp)-delayXYZ);
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		predictInternal(useControlGains ? controlIterator-&gt;twist : geometry_msgs::Twist(),
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				(predictTo - predictdUpToTimestamp)*1000,
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				useControlGains &amp;&amp;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				getMS(controlIterator-&gt;header.stamp) + 200 &gt; predictdUpToTimestamp - delayControl);				// control max. 200ms old.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		//cout &lt;&lt; &quot; &quot; &lt;&lt; (predictTo - predictdUpToTimestamp);
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// if an observation needs to be added, it HAS to have a stamp equal to [predictTo],
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// as we just set [predictTo] to that timestamp.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		bool observedXYZ = false, observedRPY=false;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(rpyIterator != navdataQueue-&gt;end() &amp;&amp; getMS(rpyIterator-&gt;header.stamp)-delayRPY == predictTo)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			if(this-&gt;useNavdata)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				observeIMU_RPY(&amp;(*rpyIterator));
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			observedRPY = true;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			//cout &lt;&lt; &quot;a&quot;;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		}
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(xyzIterator != navdataQueue-&gt;end() &amp;&amp; getMS(xyzIterator-&gt;header.stamp)-delayXYZ == predictTo)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			if(this-&gt;useNavdata)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				observeIMU_XYZ(&amp;(*xyzIterator));
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			observedXYZ = true;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			//cout &lt;&lt; &quot;p&quot;;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		}
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		predictdUpToTimestamp = predictTo;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(consume)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			if(node-&gt;logfileFilter != NULL)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				pthread_mutex_lock(&amp;(node-&gt;logFilter_CS));
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				(*(node-&gt;logfileFilter)) &lt;&lt; predictdUpToTimestamp &lt;&lt; &quot; &quot; &lt;&lt; 0 &lt;&lt; &quot; &quot; &lt;&lt; 0 &lt;&lt; &quot; &quot; &lt;&lt; 0 &lt;&lt; &quot; &quot; &lt;&lt;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">					0 &lt;&lt; &quot; &quot; &lt;&lt; 0 &lt;&lt; &quot; &quot; &lt;&lt; 0 &lt;&lt; &quot; &quot; &lt;&lt;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">					controlIterator-&gt;twist.linear.y &lt;&lt; &quot; &quot; &lt;&lt; controlIterator-&gt;twist.linear.x &lt;&lt; &quot; &quot; &lt;&lt; controlIterator-&gt;twist.linear.z &lt;&lt; &quot; &quot; &lt;&lt; controlIterator-&gt;twist.angular.z &lt;&lt; &quot; &quot; &lt;&lt;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">					(observedRPY ? rpyIterator-&gt;rotX : -1) &lt;&lt; &quot; &quot; &lt;&lt; (observedRPY ? rpyIterator-&gt;rotY : -1) &lt;&lt; &quot; &quot; &lt;&lt; (observedRPY ? lastdYaw : -1) &lt;&lt; &quot; &quot; &lt;&lt;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">					(observedXYZ ? xyzIterator-&gt;vx : -1) &lt;&lt; &quot; &quot; &lt;&lt; (observedXYZ ? xyzIterator-&gt;vy : -1) &lt;&lt; &quot; &quot; &lt;&lt; (observedXYZ ? lastdZ : -1) &lt;&lt; &quot; &quot; &lt;&lt;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">					x.state[0] &lt;&lt; &quot; &quot; &lt;&lt; y.state[0] &lt;&lt; &quot; &quot; &lt;&lt; z.state[0] &lt;&lt; &quot; &quot; &lt;&lt; roll.state &lt;&lt; &quot; &quot; &lt;&lt; pitch.state &lt;&lt; &quot; &quot; &lt;&lt; yaw.state[0] &lt;&lt; &quot; &quot; &lt;&lt; x.state[1] &lt;&lt; &quot; &quot; &lt;&lt; y.state[1] &lt;&lt; &quot; &quot; &lt;&lt; z.state[1] &lt;&lt; &quot; &quot; &lt;&lt; yaw.state[1] &lt;&lt; &quot; &quot; &lt;&lt;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">					lastVXGain &lt;&lt; &quot; &quot; &lt;&lt; lastVYGain &lt;&lt; &quot; &quot; &lt;&lt; &quot;\n&quot;;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">				pthread_mutex_unlock(&amp;(node-&gt;logFilter_CS));
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			}
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		}
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(observedRPY) rpyIterator++;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(observedXYZ) xyzIterator++;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		// if this is where we wanna get, quit.
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">		if(predictTo == timestamp)
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">			break;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	}
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	//cout &lt;&lt; endl;
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">}</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div><b><span style="color: rgb(128, 0, 128);font-family:gotham, helvetica, arial, sans-serif;font-size:14px;"><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans; font-size: 16px;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span></b>

</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(51, 153, 102);"><span style="font-size: 24px;">s.scale = filter-&gt;getCurrentScales()[0];</span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">TooN::Vector&lt;3&gt; DroneKalmanFilter::<span style="color: rgb(255, 0, 0);">getCurrentScales</span>()
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">	return TooN::makeVector(scale_xyz_initialized ? xy_scale : 1, scale_xyz_initialized ? xy_scale : 1, scale_xyz_initialized ? z_scale : 1);
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">}</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div><span style="font-family: &quot;Helvetica Neue&quot;, Arial, sans;"><span style="color: rgb(51, 153, 102);"><span style="font-size: 24px;">s.scaleAccuracy = filter-&gt;getScaleAccuracy();</span></span></span></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">float DroneKalmanFilter::<span style="color: rgb(255, 0, 0);">getScaleAccuracy</span>()
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">{
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">return 0.5 + 0.5*std::min(1.0,std::max(0.0,xyz_sum_PTAMxIMU * xy_scale/4));	// scale-corrected PTAM x IMU
</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;">}</div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div><div style="font-family:&quot;Helvetica Neue&quot;, Arial, sans;font-size:16px;"><br/></div></span>
</div></body></html> 